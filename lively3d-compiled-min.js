/*!
Copyright (C) 2012 Jari-Pekka Voutilainen

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

*/
typeof Lively3D=="undefined"&&(Lively3D={});var Lively3D=function(e){var t="",n="canvas";e.THREE={renderer:null,camera:null},e.WIDGET={mainWindow:null};var r=[],i=0,s={Id:"mainscene",Model:null,Init:function(){this.Model=new THREEJS_WIDGET3D.GridWindow({width:2e3,height:2e3,color:6980693,defaultControls:!0}),this.Model.setZ(200),e.WIDGET.mainWindow.addChild(this.Model)},CreateApplication:function(e){var t=new THREEJS_WIDGET3D.GridIcon({picture:"../images/app.png",color:61013,parent:this.Model});return t},RenderingFunction:function(e,t){this.Model.update()},Open:function(e,t){},Close:function(e,t){},Remove:function(){this.Model.remove()}},o=[];e.Init=function(u){function l(){requestAnimFrame(l,u),f=parseInt((new Date).getTime()),r[i].GetScene().RenderingFunction(f,a);for(var e=0;e<o.length;++e){var t=o[e].GetWindowObject();t.isVisible_&&t.update()}THREEJS_WIDGET3D.render(),a=f}u?t=u:t=n;var u=document.getElementById(t);e.THREE.renderer=new THREE.WebGLRenderer({canvas:u,antialias:!0,autoClear:!1}),e.THREE.renderer.setClearColorHex(16382457,1),e.THREE.renderer.setSize(u.width,u.height),e.WIDGET.mainWindow=THREEJS_WIDGET3D.init({renderer:e.THREE.renderer}),e.THREE.camera=THREEJS_WIDGET3D.camera,e.THREE.camera.position.z=2800,r.push((new e.Scene).SetScene(s)),r[i].GetScene().Init(),r[i].SetModel(r[i].GetScene().Model),e.UI.create(r[i]);var a=0,f;l()},e.AddApplication=function(t,n,s){var l=new e.Application;o.push(l),l.SetName(t).SetApplicationCode(n).SetInitializationCode(s);var c=s(n),p=c.GetCanvas();l.SetStart(c.StartApp);var d=new THREE.Texture(p),v=new THREE.MeshBasicMaterial({map:d});d.needsUpdate=!0;var m=new THREEJS_WIDGET3D.TitledWindow({title:t,width:1500,height:1500,material:v,defaultControls:!0});e.WIDGET.mainWindow.addChild(m);var g=r[i].GetScene().CreateApplication(p),y=function(e){e.mesh_.material.map&&(e.mesh_.material.map.needsUpdate=!0)};return m.addUpdateCallback(y,m),m.setZ(1e3),m.hide(),l.SetWindowObject(m),l.SetIcon(g),c.GetState&&l.SetSave(c.GetState),c.SetState&&l.SetLoad(c.SetState),c.Open&&l.SetAppOpen(c.Open),c.Close&&l.SetAppClose(c.Close),c.SetLivelyApp(l),g.addEventListener(WIDGET3D.EventType.ondblclick,a,l),m.closeButton_.addEventListener(WIDGET3D.EventType.onclick,u,l),m.title_.addEventListener(WIDGET3D.EventType.ondblclick,f,l),h(m,c.EventListeners,l),l};var u=function(t,n){e.Close(n)},a=function(t,n){e.Open(n)},f=function(e,t){var n=t.GetWindowObject();t.isMaximized()?(c(n),t.Minimize()):(l(n),t.Maximize())},l=function(t){var n=t.getLocation(),r={x:e.THREE.camera.position.x-n.x,y:e.THREE.camera.position.y-n.y,z:e.THREE.camera.position.z-n.z};t.d=r,t.setLocation(n.x+.3*r.x,n.y+.3*r.y,n.z+.3*r.z),console.log(t.getLocation())},c=function(e){var t=e.getLocation();e.setLocation(t.x-.3*e.d.x,t.y-.3*e.d.y,t.z-.3*e.d.z),console.log(e.getLocation())},h=function(e,t,n){if(e&&t){var r=!1,i=!1,s=!1,o=!1;for(var u in t)p(e,u,t,n),u=="click"?r=!0:u=="mousedown"&&(i=!0);!r&&!i&&e.addEventListener(WIDGET3D.EventType.onclick,d,{app:n,callback:!1})}},p=function(e,t,n,r){switch(t){case"click":return e.addEventListener(WIDGET3D.EventType.onclick,d,{app:r,callback:n.click}),!0;case"dblclick":return e.addEventListener(WIDGET3D.EventType.ondblclick,d,{app:r,callback:n.dblclick}),!0;case"mousemove":return e.addEventListener(WIDGET3D.EventType.onmousemove,d,{app:r,callback:n.mousemove}),!0;case"mousedown":return e.addEventListener(WIDGET3D.EventType.onmousedown,d,{app:r,callback:n.mousedown}),!0;case"mouseup":return e.addEventListener(WIDGET3D.EventType.onmouseup,d,{app:r,callback:n.mouseup}),!0;case"mouseover":return e.addEventListener(WIDGET3D.EventType.onmouseover,d,{app:r,callback:n.mouseover}),!0;case"mouseout":return e.addEventListener(WIDGET3D.EventType.onmouseout,d,{app:r,callback:n.mouseout}),!0;case"keypress":return e.addEventListener(WIDGET3D.EventType.onkeypress,n.keypress),!0;case"keydown":return e.addEventListener(WIDGET3D.EventType.onkeydown,n.keydown),!0;case"keyup":return e.addEventListener(WIDGET3D.EventType.onkeyup,n.keyup),!0;default:return console.log("default: "+t),!1}},d=function(e,t){var n=t.app.GetWindowObject();(e.type=="click"||e.type=="mousedown")&&n.focus();if(t.callback){var r=(n.mousePosition_.x- -n.width_/2)/n.width_,i=(n.mousePosition_.z- -n.height_/2)/n.height_,s=n.mesh_.material.map.image.width,o=n.mesh_.material.map.image.height,u=r*s,a=i*o,f=[u,a],l={coord:f,canvas:n.mesh_.material.map.image,event:e};t.callback(l)}};e.Open=function(e){r[i].GetScene().Open(e),e.Open(),e.GetWindowObject().show(),e.GetWindowObject().focus()},e.Close=function(e){var t=e.GetWindowObject();e.isMaximized()&&(c(t),e.Minimize()),e.Close(),t.hide(),r[i].GetScene().Close(e)},e.GetCurrentSceneIndex=function(){return i},e.FileOperations={},e.FileOperations.getScript=function(e,t){$.get("getFile.php",{name:e,path:t},function(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,document.head.appendChild(t)})},e.FileOperations.uploadScript=function(e,t,n){$.post("uploadfile.php",{name:e,file:t,path:n},function(){console.log("uploaded script: "+e)})},e.FileOperations.getJSON=function(e,t,n){$.get("getFile.php",{name:e,JSON:!0,path:n},function(e){$.getJSON(e,t)})},e.FileOperations.LoadResources=function(e,t){$.get("getFileArray.php",{"names[]":e.Resources[t],path:e.ResourcePath},function(n){var r=JSON.parse(n);e.ResourceHandlers[t](r),e.ResourcesLoaded(t)})},e.AllowAppStart=function(t){t.StateFromDropbox==1&&(t.OpenAfterLoad==1&&e.Open(t),t.MaximizeAfterLoad==1&&e.Maximize(t)),e.UI.ShowLoadCompleted()};var v=[];e.AddScene=function(t){console.log("Loading scene.."),v.push(t),e.LoadResources(t),e.SceneLoader()},e.SceneLoader=function(){var t=!1;for(var n in v)v.hasOwnProperty(n)&&(r.push((new e.Scene).SetScene(v[n])),console.log(v[n]),v.splice(n,1),t=!0);t==0&&console.log("error loading scene")},e.GetCurrentScene=function(){return r[i]},e.GetApplications=function(){return o},e.ChangeScene=function(t,n){for(var s in o)o.hasOwnProperty(s)&&(o[s].isClosed()||e.Close(o[s]));r[i].GetScene().Remove(),i+=1,i==r.length&&(i=0),r[i].GetScene().Init(),r[i].SetModel(r[i].GetScene().Model);for(var s in o){var u=r[i].GetScene().CreateApplication(o[s].GetWindowObject().mesh_.material.map.image);u.addEventListener(WIDGET3D.EventType.ondblclick,a,o[s]),o[s].SetIcon(u)}},e.LoadCompleted=function(){e.UI.ShowLoadCompleted()},e.Sync=function(e,t){t.Lively3D.Proxies.Local.CheckAvailability(function(){t.Lively3D.Proxies.Local.Sync()})},e.LoadResources=function(t){for(var n in t.Resources)t.Resources.hasOwnProperty(n)&&(e.UI.HTTPServers.LOCAL.inUse==1?e.Proxies.Local.LoadResources(t,n):(e.UI.HTTPServers.PROXY.inUse==1||e.UI.HTTPServers.NODE.inUse==1)&&e.FileOperations.LoadResources(t,n))};var m;return e.SetUsername=function(e){m=e},e.GetUsername=function(){return m},e}(Lively3D);(function(e){e.Application=function(){this.Save=function(){var e={};return e},this.Load=function(e){};var e=!0;this.isClosed=function(){return e};var t=function(){};this.Close=function(){e=!0,t()},this.SetAppClose=function(e){return t=e,this};var n=function(){};this.Open=function(){e=!1,n()},this.SetAppOpen=function(e){return n=e,this};var r=!1;this.isMaximized=function(){return r},this.Maximize=function(){r=!0},this.Minimize=function(){r=!1};var i;this.SetIcon=function(e){i=e},this.GetIcon=function(){return i};var s;this.SetWindowObject=function(e){return s=e,this},this.GetWindowObject=function(){return s};var o;this.SetName=function(e){return o=e,this},this.GetName=function(){return o};var u;this.SetApplicationCode=function(e){return u=e,this},this.GetApplicationCode=function(){return u};var a;this.SetInitializationCode=function(e){return a=e,this},this.GetInitializationCode=function(){return a},this.SetSave=function(e){return this.Save=e,this},this.SetLoad=function(e){return this.Load=e,this},this.SetStart=function(e){return this.StartApp=e,this}}})(Lively3D),function(e){e.Scene=function(){var e;this.SetModel=function(t){return e=t,this},this.GetModel=function(){return e};var t;this.SetScene=function(e){return t=e,this},this.GetScene=function(){return t}}}(Lively3D),function(e){e.UI={},e.UI.HTTPServers={LOCAL:{inUse:!1},NODE:{inUse:!1},PROXY:{inUse:!0}},e.UI.Widgets={usernameDialog:null,saveStateDialog:null,loadStateDialog:null,addApp:null,loadSceneDialog:null,menu:null},e.UI.create=function(t){e.UI.Widgets.usernameDialog=new THREEJS_WIDGET3D.Dialog({text:"Enter Username",buttonText:"Ok",color:9620646}),e.UI.Widgets.usernameDialog.setZ(1500),e.WIDGET.mainWindow.addChild(e.UI.Widgets.usernameDialog);var n=function(e,t){t.dialog.textBox_.string_.length>0&&(t.Lively3D.SetUsername(t.dialog.textBox_.string_),t.dialog.remove(),t.scene.show(),t.Lively3D.UI.Widgets.menu.show())},r=[];r.push({string:"Load Application",onclick:{handler:e.UI.ShowAppList,parameters:{Lively3D:e}}}),r.push({string:"Save Desktop",onclick:{handler:e.UI.ShowSaveDialog,parameters:{Lively3D:e}}}),r.push({string:"Load Desktop",onclick:{handler:e.UI.ShowStateList,parameters:{Lively3D:e}}}),r.push({string:"Load Scene",onclick:{handler:e.UI.ShowSceneList,parameters:{Lively3D:e}}}),r.push({string:"Switch Scene",onclick:{handler:e.ChangeScene,parameters:{Lively3D:e}}}),r.push({string:"Use Node.js",onclick:{handler:e.UI.ToggleNode,parameters:{Lively3D:e}}}),r.push({string:"About",onclick:{handler:e.UI.ShowAbout,parameters:{Lively3D:e}}}),r.push({string:"Sync for local usage",onclick:{handler:e.Sync,parameters:{Lively3D:e}}}),e.UI.Widgets.menu=new THREEJS_WIDGET3D.SelectDialog({width:1300,height:3500,choices:r,color:9620646}),e.UI.Widgets.menu.setLocation(-2750,250,-100),e.UI.Widgets.menu.setRotX(-Math.PI/100),e.WIDGET.mainWindow.addChild(e.UI.Widgets.menu),e.UI.Widgets.usernameDialog.button_.addEventListener(WIDGET3D.EventType.onclick,n,{dialog:e.UI.Widgets.usernameDialog,scene:t.GetModel(),Lively3D:e}),e.UI.Widgets.usernameDialog.focus(),e.WIDGET.mainWindow.hideNotFocused()},e.UI.ToggleNode=function(e,t){t.Lively3D.UI.HTTPServers.NODE.inUse=!t.Lively3D.UI.HTTPServers.NODE.inUse,t.Lively3D.UI.HTTPServers.PROXY.inUse=!t.Lively3D.UI.HTTPServers.PROXY.inUse},e.UI.UseLocal=function(){console.log("Going offline..."),e.UI.HTTPServers.LOCAL.inUse=!0},e.UI.UseOnline=function(){console.log("Going online..."),e.UI.HTTPServers.LOCAL.inUse=!1},e.UI.ShowLoadCompleted=function(){var e=$("<div id='loadcompleted'><p>Load Compeleted</p></div>");e.appendTo("#container"),e.fadeIn("slow",function(){setTimeout(function(){e.fadeOut("slow",function(){e.remove()})},1e3)})},e.UI.ShowAppList=function(e,t){t.Lively3D.UI.HTTPServers.LOCAL.inUse==1?t.Lively3D.Proxies.Local.ShowAppList():t.Lively3D.UI.HTTPServers.PROXY.inUse==1?t.Lively3D.Proxies.PHP.ShowAppList():t.Lively3D.Proxies.Node.ShowAppList()},e.UI.LoadApplication=function(t,n){e.UI.HTTPServers.LOCAL.inUse==1?e.Proxies.Local.LoadApplication(n):e.UI.HTTPServers.PROXY.inUse==1?e.Proxies.PHP.LoadApplication(n):e.Proxies.Node.LoadApplication(n)},e.UI.ShowStateList=function(e,t){t.Lively3D.HTTPServers.UI.LOCAL.inUse==1?t.Lively3D.Proxies.Local.ShowStateList():t.Lively3D.UI.HTTPServers.PROXY.inUse==1?t.Lively3D.Proxies.PHP.ShowStateList():t.Lively3D.Proxies.Node.ShowStateList()},e.UI.ShowSceneList=function(e,t){t.Lively3D.UI.HTTPServers.LOCAL.inUse==1?t.Lively3D.Proxies.Local.ShowSceneList():t.Lively3D.UI.HTTPServers.PROXY.inUse==1?t.Lively3D.Proxies.PHP.ShowSceneList():t.Lively3D.Proxies.Node.ShowSceneList()},e.UI.LoadScene=function(t){this.HTTPServers.LOCAL.inUse==1?e.Proxies.Local.LoadScene(t):this.HTTPServers.PROXY.inUse==1?e.Proxies.PHP.LoadScene(t):e.Proxies.Node.LoadScene(t)},e.UI.SaveDesktop=function(t){this.HTTPServers.LOCAL.inUse==1?e.Proxies.Local.SaveDesktop(t):this.HTTPServers.PROXY.inUse==1?e.Proxies.PHP.SaveDesktop(t):e.Proxies.Node.SaveDesktop(t)},e.UI.LoadDesktop=function(t){this.HTTPServers.LOCAL.inUse==1?(e.Proxies.Local.LoadDesktop(t),e.UI.CloseDialog()):this.HTTPServers.PROXY.inUse==1?(e.Proxies.PHP.LoadDesktop(t),e.UI.CloseDialog()):(e.Proxies.Node.LoadDesktop(t),e.UI.CloseDialog())};var t;e.UI.ShowSaveDialog=function(e,t){var n=$('<h1>Save state</h1>State name:<input type="text" name="statename" id="statename"/><h3 onclick="Lively3D.UI.CloseSaveDialog();">Save</h3>');t.Lively3D.UI.ShowHTML(n)},e.UI.CloseSaveDialog=function(){var n=$("#statename");n[0].value.length!=0?(e.UI.SaveDesktop(n[0].value),this.CloseDialog(),t&&(e.GLGE.clickedObject=t,t=null)):$("<h3>Please supply state name</h3>").appendTo("#dialog")},e.UI.ShowAbout=function(e,t){var n=$("<h1>About</h1><p>Lively3D code made by Jari-Pekka Voutilainen</p><p>Applications developed by: Arto Salminen, Matti Anttonen, Anna-Liisa Mattila, Lotta Liikkanen, Jani Heininen, Mika V�lim�ki</p>");t.Lively3D.ShowHTML(n)},e.UI.ShowMessage=function(e){var t=$("<p>"+e+"</p>");this.ShowHTML(t)},e.UI.ActiveDialog,e.UI.ShowHTML=function(e,t){if(this.ActiveDialog!=null)this.ActiveDialog.cancelOmitted!=1&&n(e);else{if(t!=1)var r=$("<div class='dialog' id='dialog'><h3 onclick='Lively3D.UI.CloseDialog();'>Cancel</h3></div>");else{var r=$("<div class='dialog' id='dialog'></div>");r.cancelOmitted=!0}r.prepend(e),r.appendTo($("#container")),r.fadeIn("slow"),this.ActiveDialog=r}},e.UI.CloseDialog=function(){this.ActiveDialog.fadeOut("slow",function(){e.UI.ActiveDialog.remove(),e.UI.ActiveDialog=null})};var n=function(t){e.UI.ActiveDialog.fadeOut("fast",function(){e.UI.ActiveDialog.remove();var n=$("<div class='dialog' id='dialog'><h3 onclick='Lively3D.UI.CloseDialog();'>Cancel</h3></div>");n.prepend(t),n.appendTo($("#container")),n.fadeIn("fast"),e.UI.ActiveDialog=n})}}(Lively3D),function(Lively3D){Lively3D.Proxies={},Lively3D.Proxies.PHP={ShowAppList:function(){$.get("getFileList.php",{path:"apps"},function(e){var t=JSON.parse(e),n=[];for(var r in t)t.hasOwnProperty(r)&&(console.log(t[r]),n.push({string:t[r],onclick:{handler:Lively3D.UI.LoadApplication,parameters:t[r]}}));Lively3D.UI.Widgets.addApp=new THREEJS_WIDGET3D.SelectDialog({width:1e3,height:1500,choices:n,color:9620582,text:"Select Application",hasCancel:!0}),Lively3D.UI.Widgets.addApp.setLocation(0,700,450),Lively3D.WIDGET.mainWindow.addChild(Lively3D.UI.Widgets.addApp)})},LoadApplication:function(e){Lively3D.FileOperations.getScript(e,"apps/"),Lively3D.UI.Widgets.addApp.remove()},SaveDesktop:function(e){var t=Lively3D.GetApplications(),n="",r=[];for(var i in t)if(t.hasOwnProperty(i)){var s=t[i],o=s.isMaximized();s.isMaximized()==1&&Lively3D.Minimize(s);var u={Name:s.GetName(),Location:{x:s.GetCurrentSceneObject().getLocX(),y:s.GetCurrentSceneObject().getLocY(),z:s.GetCurrentSceneObject().getLocZ()},Rotation:s.GetCurrentSceneObject().getRotation(),Closed:s.isClosed(),Maximized:o,Code:s.GetApplicationCode().toString(),Init:s.GetInitializationCode().toString(),AppState:s.Save()};r.push(u),o==1&&Lively3D.Maximize(s)}n=JSON.stringify(r),Lively3D.FileOperations.uploadScript(e,n,"states/"+Lively3D.GetUsername())},LoadDesktop:function(e){Lively3D.FileOperations.getJSON(e,ParseDesktopJSON,"states/"+Lively3D.GetUsername()+"/")},ShowStateList:function(){$.get("getFileList.php",{path:"states/"+Lively3D.GetUsername()},function(e){var t=JSON.parse(e),n=$("<h1>Select State</h1><div></div>"),r=n.last();for(var i in t)if(t.hasOwnProperty(i)){var s=$("<span onclick=\"Lively3D.UI.LoadDesktop('"+t[i]+"')\">"+t[i]+"</span></br>");s.appendTo(r)}Lively3D.UI.ShowHTML(n)})},ShowSceneList:function(){$.get("getFileList.php",{path:"world"},function(e){var t=JSON.parse(e),n=$("<h1>Select Scene</h1><div></div>"),r=n.last();for(var i in t)if(t.hasOwnProperty(i)){var s=$("<span onclick=\"Lively3D.UI.LoadScene('"+t[i]+"')\">"+t[i]+"</span></br>");s.appendTo(r)}Lively3D.UI.ShowHTML(n)})},LoadScene:function(e){Lively3D.FileOperations.getScript(e,"world/"),Lively3D.UI.CloseDialog()}};var ParseDesktopJSON=function(data){var JSONArray=JSON.parse(data);for(var i in JSONArray)if(JSONArray.hasOwnProperty(i)){var JSONObject=JSONArray[i],CodeFunc=eval("("+JSONObject.Code+")"),InitFunc=eval("("+JSONObject.Init+")"),app=Lively3D.AddApplication(JSONObject.Name,CodeFunc,InitFunc);SetAppLocation(app,JSONObject.Location),SetAppRotation(app,JSONObject.Rotation),app.StateFromDropbox=!0,JSONObject.Closed!=1&&(app.OpenAfterLoad=!0),JSONObject.Maximized==1&&(app.MaximizeAfterLoad=!0),app.Load(JSONObject.AppState),app.StartApp()}},SetAppLocation=function(e,t){e.GetSceneObject(0).setLocX(t.x),e.GetSceneObject(0).setLocY(t.y),e.GetSceneObject(0).setLocZ(t.z)},SetAppRotation=function(e,t){e.GetSceneObject(0).setRotX(t.x),e.GetSceneObject(0).setRotY(t.y),e.GetSceneObject(0).setRotZ(t.z)};Lively3D.Proxies.Node={ShowAppList:function(){$.get("/lively3d/node/filelist/apps",function(e){var t=$("<h1>Select Application</h1><div></div>"),n=t.last();for(var r in e)if(e.hasOwnProperty(r)){var i=$("<span onclick=\"Lively3D.UI.LoadApplication('"+e[r]+"')\">"+e[r]+"</span></br>");i.appendTo(n)}Lively3D.UI.ShowHTML(t)})},LoadApplication:function(e){$.get("/lively3d/node/file/apps/"+e,function(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,document.head.appendChild(t)}),Lively3D.UI.CloseDialog()},SaveDesktop:function(e){var t=Lively3D.GetApplications(),n={};n.name=e,n.user=Lively3D.GetUsername(),n.applications=[];for(var r in t)if(t.hasOwnProperty(r)){var i=t[r],s=i.isMaximized();i.isMaximized()==1&&Lively3D.Minimize(i);var o={Name:i.GetName(),Location:{x:i.GetCurrentSceneObject().getLocX(),y:i.GetCurrentSceneObject().getLocY(),z:i.GetCurrentSceneObject().getLocZ()},Rotation:i.GetCurrentSceneObject().getRotation(),Closed:i.isClosed(),Maximized:s,Code:i.AppCode.toString(),Init:i.AppInit.toString(),AppState:i.Save()};n.applications.push(o),s==1&&Lively3D.Maximize(i)}$.post("/lively3d/node/states/new",{state:n},function(e){console.log(e)})},LoadDesktop:function(name){var Applications=Lively3D.GetApplications(),appcount=Applications.length;for(var i=0;i<appcount;++i){for(var i in Lively3D.GLGE.scenes)Lively3D.GLGE.scenes.hasOwnProperty(i)&&Lively3D.GLGE.scenes[i].scene.removeChild(Applications[i].current);Applications.splice(0,1)}$.get("/lively3d/node/states/"+Lively3D.GetUsername()+"/"+name,function(data){var apps=data.applications;for(var i in apps)if(apps.hasOwnProperty(i)){var JSONObject=apps[i],CodeFunc=eval("("+JSONObject.Code+")"),InitFunc=eval("("+JSONObject.Init+")"),app=Lively3D.AddApplication(JSONObject.Name,CodeFunc,InitFunc);SetAppLocation(app,JSONObject.Location),SetAppRotation(app,JSONObject.Rotation),app.StateFromDropbox=!0,JSONObject.Closed!="true"&&(app.OpenAfterLoad=!0),JSONObject.Maximized=="true"&&(app.MaximizeAfterLoad=!0),app.Load(JSONObject.AppState),app.StartApp()}})},ShowStateList:function(){$.get("/lively3d/node/states/"+Lively3D.GetUsername(),function(e){var t=$("<h1>Select State</h1><div></div>"),n=t.last();for(var r in e)if(e.hasOwnProperty(r)){var i=$("<span onclick=\"Lively3D.UI.LoadDesktop('"+e[r]+"')\">"+e[r]+"</span></br>");i.appendTo(n)}Lively3D.UI.ShowHTML(t)})},ShowSceneList:function(){$.get("/lively3d/node/filelist/scenes",function(e){var t=$("<h1>Select Scene</h1><div></div>"),n=t.last();for(var r in e)if(e.hasOwnProperty(r)){var i=$("<span onclick=\"Lively3D.UI.LoadScene('"+e[r]+"')\">"+e[r]+"</span></br>");i.appendTo(n)}Lively3D.UI.ShowHTML(t)})},LoadScene:function(e){$.get("/lively3d/node/file/scenes/"+e,function(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,document.head.appendChild(t)}),Lively3D.UI.CloseDialog()}},Lively3D.Proxies.Local={ShowAppList:function(){$.ajax({url:"http://127.0.0.1:8000/filelist/apps",success:function(e){var t=$("<h1>Select Application</h1><div></div>"),n=t.last();for(var r in e)if(e.hasOwnProperty(r)){var i=$("<span onclick=\"Lively3D.UI.LoadApplication('"+e[r]+"')\">"+e[r]+"</span></br>");i.appendTo(n)}Lively3D.UI.ShowHTML(t)}})},LoadApplication:function(e){$.get("http://127.0.0.1:8000/file/apps/"+e,function(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,document.head.appendChild(t)}),Lively3D.UI.CloseDialog()},ShowSceneList:function(){$.get("http://localhost:8000/filelist/scenes",function(e){var t=$("<h1>Select Scene</h1><div></div>"),n=t.last();for(var r in e)if(e.hasOwnProperty(r)){var i=$("<span onclick=\"Lively3D.UI.LoadScene('"+e[r]+"')\">"+e[r]+"</span></br>");i.appendTo(n)}Lively3D.UI.ShowHTML(t)})},LoadScene:function(e){$.get("http://localhost:8000/file/scenes/"+e,function(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,document.head.appendChild(t)}),Lively3D.UI.CloseDialog()},CheckAvailability:function(e){$.ajax({url:"http://localhost:8000/",success:function(t){t.success==0?Lively3D.UI.ShowMessage(t.message):e()},error:function(){Lively3D.UI.ShowMessage("Local Node.js application not found. Please run 'node local.js'")}})},Sync:function(e){$.ajax({url:"http://localhost:8000/sync",data:{host:window.location.host,port:window.location.port,path:window.location.pathname},success:function(e){e.success==1&&Lively3D.UI.ShowMessage(e.message)},error:function(){Lively3D.UI.ShowMessage("Local Node.js application not found. Please run 'node local.js' and associated Mongo-database.")}})},LoadResources:function(e,t){$.get("http://localhost:8000/filearray",{"names[]":e.Resources[t],path:e.ResourcePath},function(n){e.ResourceHandlers[t](n),e.ResourcesLoaded(t)})}}}(Lively3D)