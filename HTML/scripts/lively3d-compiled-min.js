/*!
Copyright (C) 2012 Jari-Pekka Voutilainen

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

*/
typeof Lively3D=="undefined"&&(Lively3D={});var Lively3D=function(a){var b="",c="canvas";this.renderer,a.WIDGET={mainWindow:null,cameraGroup:null};var d=[],e=0,f={Id:"mainscene",Model:null,SkySphere:null,Init:function(){var b=WIDGET3D.getScene();this.SkySphere=new THREE.Mesh(new THREE.SphereGeometry(500,32,32),new THREE.MeshBasicMaterial({color:13034239,side:THREE.BackSide})),b.add(this.SkySphere),b.fog=new THREE.Fog(9408444,20,2e3),this.Model=new WIDGET3D.GridWindow({width:200,height:200,color:3424594,defaultControls:!0}),a.WIDGET.mainWindow.add(this.Model),a.WIDGET.cameraGroup.setPositionZ(450)},CreateApplication:function(a){var b=new WIDGET3D.GridIcon({img:a,parent:this.Model}),c=function(){b.material.map.needsUpdate=!0};return b.addUpdateCallback(c),b},RenderingFunction:function(a,b){},Open:function(a,b){},Close:function(a,b){},Remove:function(){this.Model.remove();var b=WIDGET3D.getScene();b.remove(this.SkySphere),b.fog=null,a.WIDGET.cameraGroup.setPosition(0,0,0),a.WIDGET.cameraGroup.setRotation(0,0,0)}},g=[];a.Init=function(h){function k(){requestAnimationFrame(k,h),j=parseInt((new Date).getTime()),d[e].GetScene().RenderingFunction(j,i);for(var a=0;a<g.length;++a){var b=g[a].GetWindowObject();b.isVisible&&b.update()}WIDGET3D.render(),i=j}h?b=h:b=c;var h=document.getElementById(b);a.renderer=new THREE.WebGLRenderer({canvas:h,antialias:!0}),a.WIDGET.mainWindow=WIDGET3D.THREE_Application({renderer:a.renderer}),a.WIDGET.cameraGroup=WIDGET3D.getCameraGroup(),d.push((new a.Scene).SetScene(f)),d[e].GetScene().Init(),d[e].SetModel(d[e].GetScene().Model),a.UI.create(d[e]);var i=0,j;k()};var h=function(b){return function(c){a.Open(b)}};a.AddApplication=function(b,c,f){var i=new a.Application;g.push(i),i.SetName(b).SetApplicationCode(c).SetInitializationCode(f);var k=f(c),l=k.GetCanvas();i.SetStart(k.StartApp);var m=new THREE.Texture(l),n=new THREE.MeshBasicMaterial({map:m});m.needsUpdate=!0;var o=new WIDGET3D.TitledWindow({title:b,width:100,height:75,material:n,defaultControls:!0,mouseButton:2,override:!0});new WIDGET3D.RollControl(o,{mouseButton:2,shiftKey:!0}),a.WIDGET.cameraGroup.add(o),o.setPosition(0,0,-150);var p=d[e].GetScene().CreateApplication(l),q=function(a){return function(){content=a.getContent(),content.object3D.material.map&&(content.object3D.material.map.needsUpdate=!0)}},r=q(o);o.addUpdateCallback(r),o.hide(),i.SetWindowObject(o),i.SetIcon(p),k.GetState&&i.SetSave(k.GetState),k.SetState&&i.SetLoad(k.SetState),k.Open&&i.SetAppOpen(k.Open),k.Close&&i.SetAppClose(k.Close),k.SetLivelyApp(i);var s=function(b){return function(c){a.Close(b)}};return p.addEventListener("dblclick",h(i)),o.closeButton.addEventListener("click",s(i)),j(o,k.EventListeners,i),i};var i=function(a,b){var c=a.app.GetWindowObject(),d=c.getContent();if(a.callback){var e=b.mousePositionIn3D.obj,f=(e.x- -c.width/2)/c.width,g=1-(e.y- -c.height/2)/c.height,h=d.object3D.material.map.image.width,i=d.object3D.material.map.image.height,j=f*h,k=g*i,l=[j,k],m={coord:l,canvas:d.object3D.material.map.image,event:b};a.callback(m)}},j=function(a,b,c){var d=function(a){return function(b){i(a,b)}},e=function(a){return function(b){a.GetWindowObject().focus()}},f=a.getContent();if(a&&b){f.addEventListener("click",e(c));for(var g in b)g!="keypress"&&g!="keydown"&&g!="keyup"?f.addEventListener(g,d({app:c,callback:b[g.toString()]})):a.addEventListener(g,b[g.toString()])}};a.Open=function(a){d[e].GetScene().Open(a),a.Open(),a.GetWindowObject().show(),a.GetWindowObject().focus()},a.Close=function(a){var b=a.GetWindowObject();a.Close(),b.hide(),d[e].GetScene().Close(a)},a.GetCurrentSceneIndex=function(){return e},a.FileOperations={},a.FileOperations.getScript=function(a,b){$.get("getFile.php",{name:a,path:b},function(a){var b=document.createElement("script");b.type="text/javascript",b.src=a,document.head.appendChild(b)})},a.FileOperations.uploadScript=function(a,b,c){$.post("uploadfile.php",{name:a,file:b,path:c},function(){console.log("uploaded script: "+a)})},a.FileOperations.getJSON=function(a,b,c){$.get("getFile.php",{name:a,JSON:!0,path:c},function(a){$.getJSON(a,b)})},a.FileOperations.LoadResources=function(a,b){$.get("getFileArray.php",{"names[]":a.Resources[b],path:a.ResourcePath},function(c){var d=JSON.parse(c);a.ResourceHandlers[b](d),a.ResourcesLoaded(b)})},a.AllowAppStart=function(b){b.StateFromDropbox==1&&b.OpenAfterLoad==1&&a.Open(b),a.LoadCompleted()};var k=[];a.AddScene=function(b){console.log("Loading scene.."),k.push(b),a.LoadResources(b)},a.SceneLoader=function(){var b=!1;for(var c in k)k.hasOwnProperty(c)&&(d.push((new a.Scene).SetScene(k[c])),console.log(k[c]),k.splice(c,1),b=!0,a.LoadCompleted());b==0&&console.log("error loading scene")},a.GetCurrentScene=function(){return d[e]},a.GetApplications=function(){return g},a.ChangeScene=function(b,c){for(var f in g)g.hasOwnProperty(f)&&(g[f].isClosed()||a.Close(g[f]));d[e].GetScene().Remove(),e+=1,e==d.length&&(e=0),d[e].GetScene().Init(),d[e].SetModel(d[e].GetScene().Model);for(var f in g){var i=d[e].GetScene().CreateApplication(g[f].GetWindowObject().getContent().mesh_.material.map.image);i.addEventListener("dblclick",h(g[f])),g[f].SetIcon(i)}},a.LoadCompleted=function(){a.UI.ShowLoadCompleted()},a.Sync=function(b){a.Proxies.Local.CheckAvailability(function(){a.Proxies.Local.Sync()})},a.LoadResources=function(b){for(var c in b.Resources)b.Resources.hasOwnProperty(c)&&(a.UI.HTTPServers.LOCAL.inUse==1?a.Proxies.Local.LoadResources(b,c):(a.UI.HTTPServers.PROXY.inUse==1||a.UI.HTTPServers.NODE.inUse==1)&&a.FileOperations.LoadResources(b,c))};var l;return a.SetUsername=function(a){l=a},a.GetUsername=function(){return l},a}(Lively3D);(function(a){a.Application=function(){this.Save=function(){var a={};return a},this.Load=function(a){};var a=!0;this.isClosed=function(){return a};var b=function(){};this.Close=function(){a=!0,b()},this.SetAppClose=function(a){return b=a,this};var c=function(){};this.Open=function(){a=!1,c()},this.SetAppOpen=function(a){return c=a,this};var d;this.SetIcon=function(a){d=a},this.GetIcon=function(){return d};var e;this.SetWindowObject=function(a){return e=a,this},this.GetWindowObject=function(){return e};var f;this.SetName=function(a){return f=a,this},this.GetName=function(){return f};var g;this.SetApplicationCode=function(a){return g=a,this},this.GetApplicationCode=function(){return g};var h;this.SetInitializationCode=function(a){return h=a,this},this.GetInitializationCode=function(){return h},this.SetSave=function(a){return this.Save=a,this},this.SetLoad=function(a){return this.Load=a,this},this.SetStart=function(a){return this.StartApp=a,this}}})(Lively3D),function(a){a.Scene=function(){var a;this.SetModel=function(b){return a=b,this},this.GetModel=function(){return a};var b;this.SetScene=function(a){return b=a,this},this.GetScene=function(){return b}}}(Lively3D),function(a){a.UI={},a.UI.HTTPServers={LOCAL:{inUse:!1},NODE:{inUse:!1},PROXY:{inUse:!0}},a.UI.colors={menus:14935011,dialogs:15263976,notifications:10663373},a.UI.Dialogs={loadState:null,saveState:null,addApp:null,loadScene:null,about:null,username:null,loadCompleted:null,menu:null,node:null,php:null},a.UI.create=function(b){var e=function(b){return function(c){a.UI.Dialogs.username.fields[0].input.text.length>0&&(a.SetUsername(a.UI.Dialogs.username.fields[0].input.text),a.UI.Dialogs.username.remove(),b.GetModel().show(),a.UI.Dialogs.menu.show())}},f=[];f.push({text:"Log in",onclick:e(b)});var g=[];g.push({description:"Username"}),a.UI.Dialogs.username=new WIDGET3D.Dialog({title:"Log in to Lively3D",color:a.UI.colors.dialogs,buttons:f,fields:g,width:200,height:150}),a.WIDGET.cameraGroup.add(a.UI.Dialogs.username),a.UI.Dialogs.username.setPosition(0,0,-200);var h=[];h.push({string:"Load Application",onclick:{handler:a.UI.ShowAppList}}),h.push({string:"Save Desktop",onclick:{handler:a.UI.ShowSaveDialog}}),h.push({string:"Load Desktop",onclick:{handler:a.UI.ShowStateList}}),h.push({string:"Load Scene",onclick:{handler:a.UI.ShowSceneList}}),h.push({string:"Switch Scene",onclick:{handler:a.ChangeScene}}),h.push({string:"Toggle Node.js",onclick:{handler:a.UI.ToggleNode}}),h.push({string:"About",onclick:{handler:a.UI.ShowAbout}}),h.push({string:"Sync for local usage",onclick:{handler:a.Sync}}),a.UI.Dialogs.menu=new WIDGET3D.SelectDialog({width:160,height:360,choices:h,color:a.UI.colors.menus}),new WIDGET3D.DragControl(a.UI.Dialogs.menu,{mouseButton:2,width:800,height:1600}),new WIDGET3D.RollControl(a.UI.Dialogs.menu,{mouseButton:2,shiftKey:!0}),a.WIDGET.cameraGroup.add(a.UI.Dialogs.menu),a.UI.Dialogs.menu.setPosition(-240,0,-420),c(),d(),a.UI.Dialogs.menu.hide(),b.GetModel().hide()},a.UI.createAppDialog=function(c){var d=function(b){return function(c){a.UI.LoadApplication(b)}},e=[];for(var f in c)if(c.hasOwnProperty(f)){var g=d(c[f]);e.push({string:c[f],onclick:{handler:g}})}a.UI.Dialogs.addApp=b(e,"Select Application")},a.UI.createSceneDialog=function(c){var d=function(b){return function(c){a.UI.LoadScene(b)}},e=[];for(var f in c)if(c.hasOwnProperty(f)){var g=d(c[f]);e.push({string:c[f],onclick:{handler:g}})}a.UI.Dialogs.loadScene=b(e,"Select Skene")},a.UI.createStateDialog=function(c){var d=function(b){return function(c){a.UI.LoadDesktop(b)}},e=[];for(var f in c)if(c.hasOwnProperty(f)){var g=d(c[f]);e.push({string:c[f],onclick:{handler:g}})}a.UI.Dialogs.loadState=b(e,"Select Desktop")};var b=function(b,c){if(b.length==1)var d=340/3;else if(b.length<10)var d=68*b.length;else if(b.length<15)var d=340/14*b.length;else var d=360;var e=new WIDGET3D.SelectDialog({width:160,height:d,depth:2,choices:b,color:a.UI.colors.menus,opacity:.7,text:c,hasCancel:!0});return a.WIDGET.cameraGroup.add(e),e.setPosition(0,0,-420),e.setRotationX(-Math.PI/100),e},c=function(){var b=THREE.ImageUtils.loadTexture("images/loadCompleted.png"),c=new THREE.MeshBasicMaterial({map:b,color:a.UI.colors.notifications}),d=new THREE.Mesh(new THREE.PlaneGeometry(100,20),c);a.UI.Dialogs.loadCompleted=new WIDGET3D.Widget(d),a.WIDGET.cameraGroup.add(a.UI.Dialogs.loadCompleted),a.UI.Dialogs.loadCompleted.setPosition(0,0,-150),a.UI.Dialogs.loadCompleted.hide()},d=function(){var b=THREE.ImageUtils.loadTexture("images/about.png"),c=new THREE.MeshBasicMaterial({map:b,color:a.UI.colors.notifications}),d=new THREE.Mesh(new THREE.PlaneGeometry(100,100),c);a.UI.Dialogs.about=new WIDGET3D.Widget(d),a.WIDGET.cameraGroup.add(a.UI.Dialogs.about),a.UI.Dialogs.about.setPosition(0,0,-150),a.UI.Dialogs.about.hide();var e=function(b,c){a.UI.Dialogs.about.hide()};a.UI.Dialogs.about.addEventListener("click",e)},e=5;a.UI.ToggleNode=function(b){a.UI.HTTPServers.NODE.inUse=!a.UI.HTTPServers.NODE.inUse,a.UI.HTTPServers.PROXY.inUse=!a.UI.HTTPServers.PROXY.inUse,a.UI.HTTPServers.NODE.inUse?a.UI.Dialogs.menu.changeChoiceText("Toggle PHP",e):a.UI.Dialogs.menu.changeChoiceText("Toggle Node.js",e)},a.UI.UseLocal=function(){console.log("Going offline..."),a.UI.HTTPServers.LOCAL.inUse=!0},a.UI.UseOnline=function(){console.log("Going online..."),a.UI.HTTPServers.LOCAL.inUse=!1},a.UI.ShowLoadCompleted=function(){a.UI.Dialogs.loadCompleted.show(),setTimeout(function(){a.UI.Dialogs.loadCompleted.hide()},1500)},a.UI.ShowAppList=function(b){a.UI.HTTPServers.LOCAL.inUse==1?a.Proxies.Local.ShowAppList():a.UI.HTTPServers.PROXY.inUse==1?a.Proxies.PHP.ShowAppList():a.Proxies.Node.ShowAppList()},a.UI.LoadApplication=function(b){a.UI.HTTPServers.LOCAL.inUse==1?a.Proxies.Local.LoadApplication(b):a.UI.HTTPServers.PROXY.inUse==1?a.Proxies.PHP.LoadApplication(b):a.Proxies.Node.LoadApplication(b)},a.UI.ShowStateList=function(b){a.UI.HTTPServers.LOCAL.inUse==1?a.Proxies.Local.ShowStateList():a.UI.HTTPServers.PROXY.inUse==1?a.Proxies.PHP.ShowStateList():a.Proxies.Node.ShowStateList()},a.UI.ShowSceneList=function(b){a.UI.HTTPServers.LOCAL.inUse==1?a.Proxies.Local.ShowSceneList():a.UI.HTTPServers.PROXY.inUse==1?a.Proxies.PHP.ShowSceneList():a.Proxies.Node.ShowSceneList()},a.UI.LoadScene=function(b){a.UI.HTTPServers.LOCAL.inUse==1?a.Proxies.Local.LoadScene(b):a.UI.HTTPServers.PROXY.inUse==1?a.Proxies.PHP.LoadScene(b):a.Proxies.Node.LoadScene(b)},a.UI.SaveDesktop=function(b){a.UI.HTTPServers.LOCAL.inUse==1?a.Proxies.Local.SaveDesktop(b):a.UI.HTTPServers.PROXY.inUse==1?a.Proxies.PHP.SaveDesktop(b):a.Proxies.Node.SaveDesktop(b)},a.UI.LoadDesktop=function(b){a.UI.HTTPServers.LOCAL.inUse==1?a.Proxies.Local.LoadDesktop(b):a.UI.HTTPServers.PROXY.inUse==1?a.Proxies.PHP.LoadDesktop(b):a.Proxies.Node.LoadDesktop(b),a.UI.Dialogs.loadState.remove()},a.UI.ShowSaveDialog=function(b){var c=[];c.push({description:"State name"});var d=[];d.push({text:"Save",onclick:a.UI.CloseSaveDialog}),a.UI.Dialogs.saveState=new WIDGET3D.Dialog({color:a.UI.colors.dialogs,fields:c,buttons:d,title:"Save Desktop",width:200,height:150,hasCancel:!0}),a.WIDGET.cameraGroup.add(a.UI.Dialogs.saveState),a.UI.Dialogs.saveState.setPosition(0,0,-200)},a.UI.CloseSaveDialog=function(b){a.UI.Dialogs.saveState.fields[0].input.text.length>0&&(a.UI.SaveDesktop(a.UI.Dialogs.saveState.fields[0].input.text),a.UI.Dialogs.saveState.remove())},a.UI.ShowAbout=function(b){a.UI.Dialogs.about.show()}}(Lively3D),function(Lively3D){Lively3D.Proxies={},Lively3D.Proxies.PHP={ShowAppList:function(){$.get("getFileList.php",{path:"apps"},function(a){var b=JSON.parse(a);Lively3D.UI.createAppDialog(b)})},LoadApplication:function(a){Lively3D.FileOperations.getScript(a,"apps/"),Lively3D.UI.Dialogs.addApp.remove()},SaveDesktop:function(a){var b=Lively3D.GetApplications(),c="",d=[];for(var e in b)if(b.hasOwnProperty(e)){var f=b[e],g={Name:f.GetName(),Closed:f.isClosed(),Code:f.GetApplicationCode().toString(),Init:f.GetInitializationCode().toString(),AppState:f.Save()};d.push(g)}c=JSON.stringify(d),Lively3D.FileOperations.uploadScript(a,c,"states/"+Lively3D.GetUsername())},LoadDesktop:function(a){Lively3D.FileOperations.getJSON(a,ParseDesktopJSON,"states/"+Lively3D.GetUsername()+"/")},ShowStateList:function(){$.get("getFileList.php",{path:"states/"+Lively3D.GetUsername()},function(a){var b=JSON.parse(a);Lively3D.UI.createStateDialog(b)})},ShowSceneList:function(){$.get("getFileList.php",{path:"world"},function(a){var b=JSON.parse(a);Lively3D.UI.createSceneDialog(b)})},LoadScene:function(a){Lively3D.FileOperations.getScript(a,"world/"),Lively3D.UI.Dialogs.loadScene.remove()}};var ParseDesktopJSON=function(data){var Applications=Lively3D.GetApplications(),appcount=Applications.length;for(var i=0;i<appcount;++i)Applications[0].GetIcon().remove(),Applications[0].GetWindowObject().remove(),Applications.splice(0,1);var JSONArray=JSON.parse(data);for(var i in JSONArray)if(JSONArray.hasOwnProperty(i)){var JSONObject=JSONArray[i],CodeFunc=eval("("+JSONObject.Code+")"),InitFunc=eval("("+JSONObject.Init+")"),app=Lively3D.AddApplication(JSONObject.Name,CodeFunc,InitFunc);app.StateFromDropbox=!0,JSONObject.Closed!=1&&(app.OpenAfterLoad=!0),app.Load(JSONObject.AppState),app.StartApp()}};Lively3D.Proxies.Node={ShowAppList:function(){$.get("/lively3d/node/filelist/apps",function(a){Lively3D.UI.createAppDialog(a)})},LoadApplication:function(a){$.get("/lively3d/node/file/apps/"+a,function(a){var b=document.createElement("script");b.type="text/javascript",b.src=a,document.head.appendChild(b)}),Lively3D.UI.Dialogs.addApp.remove()},SaveDesktop:function(a){var b=Lively3D.GetApplications(),c={};c.name=a,c.user=Lively3D.GetUsername(),c.applications=[];for(var d in b)if(b.hasOwnProperty(d)){var e=b[d],f={Name:e.GetName(),Closed:e.isClosed(),Code:e.AppCode.toString(),Init:e.AppInit.toString(),AppState:e.Save()};c.applications.push(f)}$.post("/lively3d/node/states/new",{state:c},function(a){console.log(a)})},LoadDesktop:function(name){var Applications=Lively3D.GetApplications(),appcount=Applications.length;for(var i=0;i<appcount;++i)Applications[0].GetIcon().remove(),Applications[0].GetWindowObject().remove(),Applications.splice(0,1);$.get("/lively3d/node/states/"+Lively3D.GetUsername()+"/"+name,function(data){var apps=data.applications;for(var i in apps)if(apps.hasOwnProperty(i)){var JSONObject=apps[i],CodeFunc=eval("("+JSONObject.Code+")"),InitFunc=eval("("+JSONObject.Init+")"),app=Lively3D.AddApplication(JSONObject.Name,CodeFunc,InitFunc);app.StateFromDropbox=!0,JSONObject.Closed!="true"&&(app.OpenAfterLoad=!0),app.Load(JSONObject.AppState),app.StartApp()}})},ShowStateList:function(){$.get("/lively3d/node/states/"+Lively3D.GetUsername(),function(a){Lively3D.UI.createStateDialog(a)})},ShowSceneList:function(){$.get("/lively3d/node/filelist/world",function(a){Lively3D.UI.createSceneDialog(a)})},LoadScene:function(a){$.get("/lively3d/node/file/world/"+a,function(a){var b=document.createElement("script");b.type="text/javascript",b.src=a,document.head.appendChild(b)}),Lively3D.UI.Dialogs.loadScene.remove()}},Lively3D.Proxies.Local={ShowAppList:function(){$.ajax({url:"http://127.0.0.1:8000/filelist/apps",success:function(a){Lively3D.UI.createAppDialog(a)}})},LoadApplication:function(a){$.get("http://127.0.0.1:8000/file/apps/"+a,function(a){var b=document.createElement("script");b.type="text/javascript",b.src=a,document.head.appendChild(b)}),Lively3D.UI.Dialogs.addApp.remove()},ShowSceneList:function(){$.get("http://localhost:8000/filelist/world",function(a){Lively3D.UI.createSceneDialog(a)})},LoadScene:function(a){$.get("http://localhost:8000/file/world/"+a,function(a){var b=document.createElement("script");b.type="text/javascript",b.src=a,document.head.appendChild(b)}),Lively3D.UI.Dialogs.loadScene.remove()},CheckAvailability:function(a){$.ajax({url:"http://localhost:8000/",success:function(b){b.success==0?alert(b.message):a()},error:function(){alert("Local Node.js application not found. Please run 'node local.js'")}})},Sync:function(a){$.ajax({url:"http://localhost:8000/sync",data:{host:window.location.host,port:window.location.port,path:window.location.pathname},success:function(a){a.success==1&&alert(a.message)},error:function(){alert("Local Node.js application not found. Please run 'node local.js' and associated Mongo-database.")}})},LoadResources:function(a,b){$.get("http://localhost:8000/filearray",{"names[]":a.Resources[b],path:a.ResourcePath},function(c){a.ResourceHandlers[b](c),a.ResourcesLoaded(b)})}}}(Lively3D)