/*!
Copyright (C) 2012 Anna-Liisa Mattila / Deparment of Pervasive Computing, Tampere University of Technology

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

*/
WIDGET3D={createFunctions:function(){var e=[],t={},n,r,i,s,o=!1,u=function(){var e=0;return function(){return++e}};WIDGET3D.id=u(),WIDGET3D.getEvents=function(){return i},WIDGET3D.getCanvas=function(){return s},WIDGET3D.getApplication=function(){return n},WIDGET3D.addObject=function(e){t[e.id]=e},WIDGET3D.removeObject=function(e){delete t[e]},WIDGET3D.getObjectById=function(e){return t[e]},WIDGET3D.getAllObjects=function(){return t},WIDGET3D.getFocused=function(){return e},WIDGET3D.addFocus=function(t){e.push(t)},WIDGET3D.removeFocus=function(t){for(var n=0;n<e.length;++n)if(e[n]===t)return e.splice(n,1),!0;return!1},WIDGET3D.unfocusFocused=function(){for(var t=0;t<e.length;++t)e[t].unfocus();e=[]},WIDGET3D.isInitialized=function(){return o},WIDGET3D.init=function(e){var e=e||{};return e.container==undefined?(console.log("Container must be specified!"),console.log("Container has to be constructor method of container of used 3D-engine (eg. in three.js THREE.Object3D"),console.log("Initializing WIDGET3D failed!"),!1):(WIDGET3D.Container=e.container,e.canvas==undefined?(console.log("Canvas must be specified!"),console.log("Initializing WIDGET3D failed!"),!1):(s=e.canvas,n=new WIDGET3D.Application,e.collisionCallback==undefined||e.collisionCallback.callback==undefined?(console.log("CollisionCallback has to be JSON object containing attributes callback (and args, optional)"),console.log("Initializing WIDGET3D failed!"),!1):(i=new WIDGET3D.DomEvents(e.collisionCallback),o=!0,n)))}}},WIDGET3D.createFunctions(),WIDGET3D.getRealWidth=function(){return parseInt(window.getComputedStyle(WIDGET3D.getCanvas(),null).getPropertyValue("width"))},WIDGET3D.getRealHeight=function(){return parseInt(window.getComputedStyle(WIDGET3D.getCanvas(),null).getPropertyValue("height"))},WIDGET3D.getCanvasWidth=function(){return WIDGET3D.getCanvas().width},WIDGET3D.getCanvasHeight=function(){return WIDGET3D.getCanvas().height},WIDGET3D.mouseScreenCoordinates=function(e){var t={x:0,y:0};if(!e)e=window.event,t.x=e.x,t.y=e.y;else{var n=e.target,r=0,i=0;while(n.offsetParent)r+=n.offsetLeft,i+=n.offsetTop,n=n.offsetParent;t.x=e.pageX-r,t.y=e.pageY-i}return t},WIDGET3D.mouseCoordinates=function(e){var t=WIDGET3D.mouseScreenCoordinates(e),n=WIDGET3D.getRealWidth(),r=WIDGET3D.getRealHeight(),i={minX:0,maxX:n,minY:0,maxY:r},s=WIDGET3D.scaleCoordinates(t,i);return s},WIDGET3D.scaleCoordinates=function(e,t){var n=+((e.x-t.minX)/t.maxX)*2-1,r=-((e.y-t.minY)/t.maxY)*2+1;return{x:n,y:r}},WIDGET3D.calculateLimits=function(e,t,n){var r=e.x+t/2,i=e.x-t/2,s=e.y+n/2,o=e.y-n/2;return{minX:i,maxX:r,minY:o,maxY:s}},WIDGET3D.DomEvents=function(e){var t=this,n={callback:e.callback,args:e.args};t.enabled={},t.mainEventHandler=function(e){var n=Object.getPrototypeOf(e);n.hasOwnProperty(String("initMouseEvent"))?t.mouseEvent(e):n.hasOwnProperty(String("initKeyboardEvent"))?t.keyboardEvent(e):t.triggerEvent(e)},t.mouseEvent=function(e){var t=n.callback(e,n.args),r=e.type,i=WIDGET3D.getApplication();if(t.length>0){var s=t[0].widget;e.mousePositionIn3D=t[0].mousePositionIn3D;if(s&&s.events.hasOwnProperty(r.toString()))for(var o=0;o<s.events[r.toString()].length;++o)s.events[r.toString()][o].callback(e)}if(i.events.hasOwnProperty(r.toString()))for(var u=0;u<i.events[r.toString()].length;++u)i.events[r.toString()][u].callback(e)},t.keyboardEvent=function(e){var t=e.type,n=WIDGET3D.getApplication();for(var r=0;r<n.childEvents[t.toString()].length;++r)if(n.childEvents[t.toString()][r]!=n&&n.childEvents[t.toString()][r].inFocus){var i=n.childEvents[t.toString()][r];for(var s=0;s<i.events[t.toString()].length;++s)i.events[t.toString()][s].callback(e)}if(n.events.hasOwnProperty(t.toString()))for(var o=0;o<n.events[t.toString()].length;++o)n.events[t.toString()][o].callback(e)},t.triggerEvent=function(e,t){var n=e.type;if(!t){var r=WIDGET3D.getApplication();for(var i=0;i<r.childEvents[n.toString()].length;++i){var s=r.childEvents[n.toString()][i];for(var o=0;o<s.events[n.toString()].length;++o)s.events[n.toString()][o].callback(e)}}else{var u=WIDGET3D.getObjectById(t);for(var a=0;a<u.events[n.toString()].length;++a)u.events[n.toString()][a].callback(e)}}},WIDGET3D.DomEvents.prototype.enableEvent=function(e){if(!this.enabled.hasOwnProperty(e.toString())||this.enabled.hasOwnProperty(e.toString())&&this.enabled[e.toString()]===!1)window.addEventListener(e,this.mainEventHandler,!1),this.enabled[e.toString()]=!0},WIDGET3D.DomEvents.prototype.disableEvent=function(e){return this.enabled.hasOwnProperty(e.toString())&&this.enabled[e.toString()]===!0?(window.removeEventListener(e,this.mainEventHandler,!1),this.enabled[e.toString()]=!1,!0):!1},WIDGET3D.GuiObject=function(){this.inFocus=!1,this.id=WIDGET3D.id(),this.updateCallbacks=[],this.events={checkEvent:function(e){return this.hasOwnProperty(e.toString())&&this[e.toString()]!=0?!0:!1},addCallback:function(e,t,n){if(!this.hasOwnProperty(e.toString())||this.hasOwnProperty(e.toString())&&this[e.toString()]===!1)this[e.toString()]=[];this[e.toString()].push({callback:t,index:n})},removeCallback:function(e,t){if(this.hasOwnProperty(e.toString())&&Object.prototype.toString.apply(this[e.toString()])==="[object Array]")for(var n=0;n<this[e.toString()].length;++n)if(this[e.toString()][n].callback===t){var r=this[e.toString()][n].index;return this[e.toString()].splice(n,1),this[e.toString()].length==0&&(this[e.toString()]=!1),r}return!1},removeAll:function(e){if(this.hasOwnProperty(e.toString())&&Object.prototype.toString.apply(this[e.toString()])==="[object Array]"){var t=this[e.toString()][0].index;return this[e.toString()]=!1,t}return!1},remove:function(){var e=[];for(listener in this)if(this.hasOwnProperty(listener)&&Object.prototype.toString.apply(this[listener])==="[object Array]"){var t={name:listener,index:this[listener][0].index};e.push(t),listener=!1}return e}},WIDGET3D.addObject(this)},WIDGET3D.GuiObject.prototype.focus=function(){return this.inFocus||(this.inFocus=!0,WIDGET3D.addFocus(this)),this},WIDGET3D.GuiObject.prototype.unfocus=function(){return this.inFocus&&(this.inFocus=!1,WIDGET3D.removeFocus(this)),this},WIDGET3D.GuiObject.prototype.addEventListener=function(e,t){WIDGET3D.getEvents().enabled[e.toString()]||WIDGET3D.getEvents().enableEvent(e);if(!this.events.checkEvent(e))var n=WIDGET3D.getApplication().childEvents.addObject(e,this);else var n=this.events[e.toString()][0].index;return this.events.addCallback(e,t,n),this},WIDGET3D.GuiObject.prototype.removeEventListener=function(e,t){var n=this.events.removeCallback(e,t);if(n===!1)return!1;if(this.events[e.toString()]===!1){var r=WIDGET3D.getApplication();r.childEvents[e.toString()].splice(n,1),r.childEvents[e.toString()].length==0&&r.childEvents.removeEvent(e);for(var i=0;i<r.childEvents[e.toString()].length;++i)r.childEvents[e.toString()][i].setNewEventIndex(e,i);return!0}},WIDGET3D.GuiObject.prototype.removeEventListeners=function(e){var t=this.events.removeAll(e);if(t===!1)return!1;var n=WIDGET3D.getApplication();n.childEvents[e.toString()].splice(t,1),n.childEvents[e.toString()].length==0&&n.childEvents.removeEvent(e);for(var r=0;r<n.childEvents[e.toString()].length;++r)n.childEvents[e.toString()][r].setNewEventIndex(e,r);return!0},WIDGET3D.GuiObject.prototype.removeAllListeners=function(){var e=this.events.remove(),t=WIDGET3D.getApplication();for(var n=0;n<e.length;++n){var r=e[n].name,i=e[n].index;t.childEvents[r].splice(i,1),t.childEvents[r].length==0&&t.childEvents.removeEvent(r);for(var s=0;s<t.childEvents[r].length;++s)t.childEvents[r][s].setNewEventIndex(r,s)}return this},WIDGET3D.GuiObject.prototype.setNewEventIndex=function(e,t){for(var n=0;n<this.events[e.toString()].length;++n)this.events[e.toString()][n].index=t;WIDGET3D.getApplication().childEvents[e.toString()][t]=this},WIDGET3D.GuiObject.prototype.addUpdateCallback=function(e){return this.updateCallbacks.push(e),this},WIDGET3D.GuiObject.prototype.removeUpdateCallback=function(e){for(var t=0;t<this.updateCallbacks.length;++t)if(this.updateCallbacks[t]===e){this.updateCallbacks.splice(t,1);break}return this},WIDGET3D.GuiObject.prototype.update=function(){for(var e=0;e<this.updateCallbacks.length;++e)this.updateCallbacks[e]();return this},WIDGET3D.GuiObject.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.Widget=function(e){WIDGET3D.GuiObject.call(this),this.parent=!1,this.object3D=e!==undefined?e:!1,this.isVisible=!0,this.controls=new Array},WIDGET3D.Widget.prototype=WIDGET3D.GuiObject.prototype.inheritance(),WIDGET3D.Widget.prototype.setObject3D=function(e){return this.parent?(this.object3D?(this.parent.object3D.remove(this.object3D),this.object3D=e,this.parent.object3D.add(this.object3D)):(this.object3D=e,this.parent.object3D.add(this.object3D)),this.parent.isVisible||this.hide()):this.object3D=e,this},WIDGET3D.Widget.prototype.applyControl=function(e){return this.controls.push(e),this},WIDGET3D.Widget.prototype.removeControl=function(e){for(i=0;i<this.controls.lenght;++i)if(this.controls[i]===e){e.remove(),this.controls.splice(i,1);break}return this},WIDGET3D.Widget.prototype.show=function(){return this.isVisible||(this.isVisible=!0,this.object3D&&(this.object3D.visible=!0)),this},WIDGET3D.Widget.prototype.hide=function(){return this.isVisible&&(this.isVisible=!1,this.object3D&&(this.object3D.visible=!1),this.inFocus&&this.unfocus()),this},WIDGET3D.Widget.prototype.remove=function(){this.hide();for(var e=0;e<this.controls.length;++e)this.controls[e].remove();this.removeAllListeners(),this.parent.removeFromObjects(this),WIDGET3D.removeObject(this.id)},WIDGET3D.Widget.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.GroupBase=function(){this.children=[],this.object3D=new WIDGET3D.Container,this.isVisible=!0},WIDGET3D.GroupBase.prototype.add=function(e){return e!=this?(e.parent&&(e.parent!=WIDGET3D.getApplication()&&e.parent.removeRelatedEventListeners(e),e.parent.removeFromObjects(e)),e.parent=this,this.children.push(e),this.object3D.add(e.object3D),this):(console.log("You can't add object to it self!"),!1)},WIDGET3D.GroupBase.prototype.show=function(){if(!this.isVisible){for(var e=0;e<this.children.length;++e)this.children[e].show();WIDGET3D.Widget.prototype.show.call(this)}return this},WIDGET3D.GroupBase.prototype.hide=function(){if(this.isVisible){for(var e=0;e<this.children.length;++e)this.children[e].hide();WIDGET3D.Widget.prototype.hide.call(this)}return this},WIDGET3D.GroupBase.prototype.hideNotFocused=function(){for(var e=0;e<this.children.length;++e)this.children[e].inFocus||this.children[e].hide();return this},WIDGET3D.GroupBase.prototype.removeFromObjects=function(e){for(var t=0;t<this.children.length;++t)if(this.children[t]===e){var n=this.children.splice(t,1);return this.object3D.remove(e.object3D),n[0]}return!1},WIDGET3D.Group=function(){WIDGET3D.Widget.call(this),WIDGET3D.GroupBase.call(this),this.parent=!1},WIDGET3D.Group.prototype=WIDGET3D.Widget.prototype.inheritance(),WIDGET3D.Group.prototype.hideNotFocused=WIDGET3D.GroupBase.prototype.hideNotFocused,WIDGET3D.Group.prototype.removeFromObjects=WIDGET3D.GroupBase.prototype.removeFromObjects,WIDGET3D.Group.prototype.show=WIDGET3D.GroupBase.prototype.show,WIDGET3D.Group.prototype.hide=WIDGET3D.GroupBase.prototype.hide,WIDGET3D.Group.prototype.add=function(e){return WIDGET3D.GroupBase.prototype.add.call(this,e)?(this.addRelatedEventListeners(e),this):!1},WIDGET3D.Group.prototype.remove=function(){while(this.children.length>0)this.children[0].remove();WIDGET3D.Widget.prototype.remove.call(this)},WIDGET3D.Group.prototype.addEventListener=function(e,t){WIDGET3D.GuiObject.prototype.addEventListener.call(this,e,t);for(var n=0;n<this.children.length;++n)this.children[n].addEventListener(e,t);return this},WIDGET3D.Group.prototype.removeEventListener=function(e,t){WIDGET3D.GuiObject.prototype.removeEventListener.call(this,e,t);for(var n=0;n<this.children.length;++n)this.children[n].removeEventListener(e,t);return this},WIDGET3D.Group.prototype.removeEventListeners=function(e){for(var t=0;t<this.events[e].length;++t){var n=this.events[e][t].callback;for(var r=0;r<this.children.length;++r)this.children[t].removeEventListener(e,n)}return WIDGET3D.GuiObject.prototype.removeEventListeners.call(this,e),this},WIDGET3D.Group.prototype.removeAllListeners=function(){for(listener in this.events)if(this.events.hasOwnProperty(listener)&&Object.prototype.toString.apply(this.events[listener])==="[object Array]"){var e=listener;for(var t=0;t<this.events[listener].length;++t){var n=this.events[listener][t].callback;for(var r=0;r<this.children.length;++r)this.children[t].removeEventListener(e,n)}}return WIDGET3D.GuiObject.prototype.removeAllListeners.call(this),this},WIDGET3D.Group.prototype.removeRelatedEventListeners=function(e){for(listener in this.events)if(this.events.hasOwnProperty(listener)&&Object.prototype.toString.apply(this.events[listener])==="[object Array]"){var t=listener;for(var n=0;n<this.events[listener].length;++n){var r=this.events[listener][n].callback;e.removeEventListener(t,r)}}return this},WIDGET3D.Group.prototype.addRelatedEventListeners=function(e){for(listener in this.events)if(this.events.hasOwnProperty(listener)&&Object.prototype.toString.apply(this.events[listener])==="[object Array]"){var t=listener;for(var n=0;n<this.events[listener].length;++n){var r=this.events[listener][n].callback,i=this.events[listener][n].bubbles;e.addEventListener(t,r)}}return this},WIDGET3D.Group.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.Application=function(){WIDGET3D.GuiObject.call(this),WIDGET3D.GroupBase.call(this),this.childEvents={addObject:function(e,t){if(!this.hasOwnProperty(e.toString())||this.hasOwnProperty(e.toString())&&this[e.toString()]==0)this[e.toString()]=[];this[e.toString()].push(t);var n=this[e.toString()].length-1;return n},removeEvent:function(e){return this.hasOwnProperty(e.toString())&&this[e.toString()].length==0?(this[e.toString()]=!1,WIDGET3D.getEvents().disableEvent(e),!0):!1}}},WIDGET3D.Application.prototype=WIDGET3D.GuiObject.prototype.inheritance(),WIDGET3D.Application.prototype.add=WIDGET3D.GroupBase.prototype.add,WIDGET3D.Application.prototype.hideNotFocused=WIDGET3D.GroupBase.prototype.hideNotFocused,WIDGET3D.Application.prototype.removeFromObjects=WIDGET3D.GroupBase.prototype.removeFromObjects,WIDGET3D.Application.prototype.show=WIDGET3D.GroupBase.prototype.show,WIDGET3D.Application.prototype.hide=WIDGET3D.GroupBase.prototype.hide,WIDGET3D.Text=function(e,t){WIDGET3D.Widget.call(this,e);var t=t||{};this.mutable=t.mutable!==undefined?t.mutable:!0,this.cursor=t.cursor!==undefined?t.cursor:"|",this.maxLength=t.maxLength!==undefined?t.maxLength:!1,this.maxLineLength=t.maxLineLength!==undefined?t.maxLineLength:this.maxLength,this.endl="\n",this.currentRow="",this.text="",this.rows=[],this.textHandle=this.text,t.text&&this.setText(t.text)},WIDGET3D.Text.prototype=WIDGET3D.Widget.prototype.inheritance(),WIDGET3D.Text.prototype.setText=function(e){if(this.mutable){for(var t=0;t<e.length;++t)this.addLetter(e[t]);this.update()}return this},WIDGET3D.Text.prototype.addLetter=function(e){if(this.mutable){if(!this.maxLength||this.text.length<this.maxLength)if(!this.maxLineLength||this.currentRow.length<this.maxLineLength){this.currentRow+=e,this.text+=e;if(this.currentRow.length==this.maxLineLength||this.text.length==this.maxLength)this.rows.push(this.currentRow+this.endl),this.currentRow=""}else if(this.currentRow.length==this.maxLineLength||this.text.length==this.maxLength)this.rows.push(this.currentRow+this.endl),this.currentRow=e,this.text+=e;this.textHandle=this.text,this.inFocus&&(this.textHandle+=this.cursor),this.update()}return this},WIDGET3D.Text.prototype.erase=function(e){if(this.mutable){for(i=0;i<e;++i)this.currentRow.length!=0?(this.currentRow=this.currentRow.substring(0,this.currentRow.length-1),this.currentRow.length==0&&this.rows.length!=0&&(this.currentRow=this.rows[this.rows.length-1],this.rows.splice(-1,1),this.currentRow=this.currentRow.substring(0,this.currentRow.length-1))):this.rows.length!=0&&(this.currentRow=this.rows[this.rows.length-1],this.rows.splice(-1,1),this.currentRow=this.currentRow.substring(0,this.currentRow.length-2));this.text=this.text.substring(0,this.text.length-e),this.textHandle=this.text,this.inFocus&&(this.textHandle+=this.cursor),this.update()}return this},WIDGET3D.Text.prototype.focus=function(){return this.mutable&&!this.inFocus&&(this.textHandle=this.text+this.cursor),WIDGET3D.Widget.prototype.focus.call(this),this.update(),this},WIDGET3D.Text.prototype.unfocus=function(){return this.inFocus&&this.mutable&&(this.textHandle=this.text),WIDGET3D.Widget.prototype.unfocus.call(this),this.update(),this},WIDGET3D.Text.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.CameraGroup=function(e){WIDGET3D.Group.call(this);var e=e||{};this.camera=e.camera,this.object3D.add(this.camera)},WIDGET3D.CameraGroup.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.Control=function(e){this.component=e,this.component.applyControl(this)},WIDGET3D.Control.prototype.remove=function(){this.component.removeControl(this)},WIDGET3D.Control.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.RollControl=function(e,t){WIDGET3D.Control.call(this,e);var t=t||{};this.mouseButton=t.mouseButton!==undefined?t.mouseButton:0,this.shiftKey=t.shiftKey!==undefined?t.shiftKey:!1,this.velocity=t.velocity!==undefined?t.velocity:.04,this.rotate=!1;var n=this,r,i,s,o=this.component.getRotationY(),u=this.component.getRotationX();this.mouseupHandler=function(e){if(n.rotate){e.stopPropagation(),e.preventDefault(),n.rotate=!1;var t=WIDGET3D.getApplication();t.removeEventListener("mousemove",a),t.removeEventListener("mouseup",n.mouseupHandler)}},this.mousedownHandler=function(e){if(e.button===n.mouseButton&&e.shiftKey===n.shiftKey){e.stopPropagation(),e.preventDefault();if(!n.rotate){n.rotate=!0,r=WIDGET3D.mouseCoordinates(e),i=o,s=u;var t=WIDGET3D.getApplication();t.addEventListener("mousemove",a),t.addEventListener("mouseup",n.mouseupHandler)}}};var a=function(e){if(n.rotate){e.stopPropagation(),e.preventDefault();var t=WIDGET3D.mouseCoordinates(e);o=i+(t.x-r.x),u=s+(t.y-r.y)}};this.mouseButton==2&&WIDGET3D.getApplication().addEventListener("contextmenu",function(e){e.stopPropagation(),e.preventDefault()}),this.component.addEventListener("mousedown",this.mousedownHandler);var f=function(){var e=n.component.getRotation(),t=e.y+(o-e.y)*n.velocity,r=e.x+(u-e.x)*n.velocity;n.component.setRotationY(t),n.component.setRotationX(r)};this.component.addUpdateCallback(f)},WIDGET3D.RollControl.prototype=WIDGET3D.Control.prototype.inheritance(),WIDGET3D.RollControl.prototype.remove=function(){this.component.removeEventListener("mousedown",this.mousedownHandler),this.rotate&&this.mouseupHandler(),WIDGET3D.Control.prototype.remove.call(this)};var THREEJS_WIDGET3D={createFunctions:function(){var e=!1,t,n,r,i,s;WIDGET3D.render=function(){var e=WIDGET3D.getAllObjects();for(var r in e)e.hasOwnProperty(r)&&e[r].update();t.render(i,n)},WIDGET3D.setViewport=function(e,r,i){t.setSize(e,r),n.aspect=i,n.updateProjectionMatrix()},WIDGET3D.getRenderer=function(){return t},WIDGET3D.getCamera=function(){return n},WIDGET3D.getCameraGroup=function(){return r},WIDGET3D.getProjector=function(){return s},WIDGET3D.getScene=function(){return i},WIDGET3D.isPluginInitialized=function(){return e},WIDGET3D.checkIfHits=function(e){var t=WIDGET3D.mouseCoordinates(e),n=new THREE.Vector3(t.x,t.y,1),r=WIDGET3D.getProjector().pickingRay(n,WIDGET3D.getCamera()),s=r.intersectObjects(i.children,!0),o=[];if(s.length>0){for(var u=0;u<s.length;++u)if(s[u].object.visible){var a=s[u].object,f=new THREE.Matrix4;f.getInverse(s[u].object.matrixWorld);var l=s[u].point.clone().applyProjection(f),c=s[u].point.clone(),h=WIDGET3D.findObject(a,e.type);if(h){var p={obj:l,world:c};o.push({widget:h,mousePositionIn3D:p})}}return o}return!1},WIDGET3D.findObject=function(e,t){var n=WIDGET3D.getApplication();for(var r=0;r<n.childEvents[t.toString()].length;++r)if(n.childEvents[t.toString()][r].isVisible&&e===n.childEvents[t.toString()][r].object3D)return n.childEvents[t.toString()][r];return!1},WIDGET3D.THREE_Application=function(o){if(!e){var o=o||{};if(o.renderer)t=o.renderer;else{var u=o.width!==undefined?o.width:window.innerWidth,a=o.height!==undefined?o.height:window.innerHeight,f=o.antialias!==undefined?o.antialias:!0,l=o.domParent!==undefined?o.domParent:document.body;t=new THREE.WebGLRenderer({antialias:f}),t.setSize(u,a);var c=o.clearColor!==undefined?o.clearColor:3355443,h=o.opacity!==undefined?o.opacity:1;t.setClearColor(c,h),l.appendChild(t.domElement)}if(o.camera)n=o.camera;else{var p=o.aspect!==undefined?o.aspect:t.domElement.width/t.domElement.height,d=o.fov!==undefined?o.fov:50,v=o.near!==undefined?o.near:.1,m=o.far!==undefined?o.far:2e3;n=new THREE.PerspectiveCamera(d,p,v,m)}i=o.scene!==undefined?o.scene:new THREE.Scene;var g=!1;if(!WIDGET3D.isInitialized()){g=WIDGET3D.init({collisionCallback:{callback:WIDGET3D.checkIfHits},container:THREE.Object3D,canvas:t.domElement});if(!g)return console.log("Widget3D init failed!"),!1}else g=WIDGET3D.getApplication();return i.add(g.object3D),s=new THREE.Projector,r=new WIDGET3D.CameraGroup({camera:n}),g.add(r),e=!0,g}return console.log("nothing to init"),WIDGET3D.getApplication()}}};THREEJS_WIDGET3D.createFunctions(),WIDGET3D.Widget.prototype.getPosition=function(){return this.object3D.position},WIDGET3D.Widget.prototype.getPositionX=function(){return this.object3D.position.x},WIDGET3D.Widget.prototype.getPositionY=function(){return this.object3D.position.y},WIDGET3D.Widget.prototype.getPositionZ=function(){return this.object3D.position.z},WIDGET3D.Widget.prototype.setPosition=function(e,t,n){return this.object3D.position.set(e,t,n),this},WIDGET3D.Widget.prototype.setPositionX=function(e){return this.object3D.position.setX(e),this},WIDGET3D.Widget.prototype.setPositionY=function(e){return this.object3D.position.setY(e),this},WIDGET3D.Widget.prototype.setPositionZ=function(e){return this.object3D.position.setZ(e),this},WIDGET3D.Widget.prototype.getRotation=function(){return this.object3D.rotation},WIDGET3D.Widget.prototype.getRotationX=function(){return this.object3D.rotation.x},WIDGET3D.Widget.prototype.getRotationY=function(){return this.object3D.rotation.y},WIDGET3D.Widget.prototype.getRotationZ=function(){return this.object3D.rotation.z},WIDGET3D.Widget.prototype.getRotationMatrix=function(){var e=new THREE.Matrix4;return e.extractRotation(this.object3D.matrix),e},WIDGET3D.Widget.prototype.setRotation=function(e,t,n){return this.object3D.rotation.set(e,t,n),this},WIDGET3D.Widget.prototype.setRotationX=function(e){return this.object3D.rotation.x=e,this},WIDGET3D.Widget.prototype.setRotationY=function(e){return this.object3D.rotation.y=e,this},WIDGET3D.Widget.prototype.setRotationZ=function(e){return this.object3D.rotation.z=e,this},WIDGET3D.Widget.prototype.applyMatrix=function(e){return this.object3D.applyMatrix(e),this},WIDGET3D.Widget.prototype.rotateOnAxis=function(e,t){var n=this.object3D.rotateOnAxis(e,t);return this},WIDGET3D.Widget.prototype.translateOnAxis=function(e,t){return this.object3D.translateOnAxis(e,t),this},WIDGET3D.Widget.prototype.translateX=function(e){return this.object3D.translateX(e),this},WIDGET3D.Widget.prototype.translateY=function(e){return this.object3D.translateY(e),this},WIDGET3D.Widget.prototype.translateZ=function(e){return this.object3D.translateZ(e),this},WIDGET3D.Widget.prototype.localToWorld=function(e){return this.object3D.localToWorld(e)},WIDGET3D.Widget.prototype.worldToLocal=function(e){return this.object3D.worldToLocal(e)},WIDGET3D.Widget.prototype.lookAt=function(e){return this.object3D.lookAt(e),this},WIDGET3D.Widget.prototype.updateMatrix=function(){return this.object3D.updateMatrix(),this},WIDGET3D.Widget.prototype.updateMatrixWorld=function(e){return this.object3D.updateMatrixWorld(e),this},WIDGET3D.Widget.prototype.computeBoundingBox=function(){return this.object3D.geometry.computeBoundingBox(),this.getBoundingBox()},WIDGET3D.Widget.prototype.getBoundingBox=function(){return this.object3D.geometry.boundingBox},WIDGET3D.Widget.prototype.computeBoundingSphere=function(){return this.object3D.geometry.computeBoundingSphere(),this.getBoundingSphere()},WIDGET3D.Widget.prototype.getBoundingSphere=function(){return this.object3D.geometry.boundingSphere},WIDGET3D.Group.prototype.computeBoundingBox=function(){var e=this.getBoundingSphere();return e==undefined&&(e=this.computeBoundingSphere()),this.boundingBox=e.getBoundingBox(),this.boundingBox},WIDGET3D.Group.prototype.getBoundingBox=function(){return this.boundingBox},WIDGET3D.Group.prototype.computeBoundingSphere=function(){var e=this.getPosition(),t=0;for(var n=0;n<this.children.length;++n){var r=this.children[n].computeBoundingSphere(),i=e.distanceTo(r.center)+r.radius;n==0&&(t=i),i>t&&(t=i)}return this.boundingSphere=new THREE.Sphere(e,t),this.boundingSphere},WIDGET3D.Group.prototype.getBoundingSphere=function(){return this.boundingSphere},WIDGET3D.GridWindow=function(e){var t=this;WIDGET3D.Group.call(this);var e=e||{};this.width=e.width!==undefined?e.width:1e3,this.height=e.height!==undefined?e.height:1e3,this.density=e.density!==undefined?e.density:6,this.depth=this.width/this.density,this.maxChildren=this.density*this.density,this.color=e.color!==undefined?e.color:7039851,this.lineWidth=e.lineWidth!==undefined?e.lineWidth:2,this.opacity=e.opacity!==undefined?e.opacity:.5,this.material=new THREE.MeshBasicMaterial({color:this.color,opacity:this.opacity,wireframe:!0,side:THREE.DoubleSide,wireframeLinewidth:this.lineWidth});var n=new THREE.CubeGeometry(this.width,this.height,this.depth,this.density,this.density,1),r=new THREE.Mesh(n,this.material);this.grid=new WIDGET3D.Widget,this.grid.setObject3D(r);var i=e.hideGrid!==undefined?e.hideGrid:!1;i&&this.grid.hide(),this.add(this.grid),this.icons=new Array,this.gridIndexes=new Array,this.defaultControls=e.defaultControls!==undefined?e.defaultControls:!1;if(this.defaultControls)var s=e.mouseButton!==undefined?e.mouseButton:0,o=e.shiftKey!==undefined?e.shiftKey:!1,u=new WIDGET3D.RollControl(this,{mouseButton:s,shiftKey:o});this.calculateGrid()},WIDGET3D.GridWindow.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.GridWindow.prototype.addSlots=function(e){this.density=e,this.maxChildren=e*e,this.depth=this.width/this.density;var t=new THREE.CubeGeometry(this.width,this.height,this.depth,this.density,this.density,1),n=new THREE.Mesh(t,this.material);this.grid.setObject3D(n),this.calculateGrid();var r=this.icons;this.icons=new Array;for(var i=0;i<r.length;++i){var s=r[i];this.icons.push(s),s.setNewSize();var o=this.gridIndexes[i];s.setPosition(o.x,o.y,o.z)}return this},WIDGET3D.GridWindow.prototype.add=function(e){return e!=this?(e.parent&&(e.parent!=WIDGET3D.getApplication()&&e.parent.removeRelatedEventListeners(e),e.parent.removeFromObjects(e)),e.parent=this,this.children.push(e),this.object3D.add(e.object3D),e!=this.grid&&(this.icons.push(e),e.setNewSize(),this.icons.length>this.maxChildren?(console.log("Grid is full! Creating bigger one"),this.addSlots(Math.ceil(this.density*1.5))):(pos=this.gridIndexes[this.icons.length-1],e.setPosition(pos.x,pos.y,pos.z))),this):(console.log("You can't add object to it self!"),!1)},WIDGET3D.GridWindow.prototype.removeFromIcons=function(e){for(var t=0;t<this.icons.length;++t)if(this.icons[t]===e){var n=this.icons.splice(t,1);return n[0]}return!1},WIDGET3D.GridWindow.prototype.removeFromObjects=function(e){WIDGET3D.Group.prototype.removeFromObjects.call(this,e),this.removeFromIcons(e);for(var t=0;t<this.icons.length;++t){var n=this.icons[t],r=this.gridIndexes[t];n.setPosition(r.x,r.y,r.z)}},WIDGET3D.GridWindow.prototype.calculateGrid=function(){this.gridIndexes=new Array;var e=this.getPosition(),t=-this.width/2+e.x/this.width,n=this.height/2+e.y/this.height,r=this.width/this.density,i=this.height/this.density,s=r/2,o=i/2,u=t+s,a=n-o;for(var f=0;f<this.maxChildren;++f){if(f==0)var l=u,c=a;else if(f%this.density==0)var l=t+s,c=a-i;else var l=u+i,c=a;u=l,a=c,this.gridIndexes.push({x:l,y:c,z:e.z/this.height})}},WIDGET3D.GridIcon=function(e){WIDGET3D.Widget.call(this);var e=e||{},t=e.parent;if(t==undefined)return console.log("GridIcon needs to have grid window as parent!"),console.log("Parent has to be given in parameters."),!1;this.color=e.color!==undefined?e.color:16777215,this.url=e.url!==undefined?e.url:!1,this.img=e.img!==undefined?e.img:!1,this.metadata=e.metadata!==undefined?e.metadata:!1,this.width=t.width/(t.density+3.3),this.height=t.height/(t.density+3.3),this.depth=e.depth!==undefined?e.depth:this.height;var n=new THREE.CubeGeometry(this.width,this.height,this.depth);this.texture=!1,this.img?(this.texture=new THREE.Texture(this.img),this.texture.needsUpdate=!0):this.url&&(this.texture=THREE.ImageUtils.loadTexture(this.url)),this.material=new THREE.MeshBasicMaterial({map:this.texture,color:this.color});var r=new THREE.Mesh(n,this.material);this.setObject3D(r),t.add(this)},WIDGET3D.GridIcon.prototype=WIDGET3D.Widget.prototype.inheritance(),WIDGET3D.GridIcon.prototype.setNewSize=function(){this.width=this.parent.width/(this.parent.density+3.3),this.height=this.parent.height/(this.parent.density+3.3);var e=new THREE.CubeGeometry(this.width,this.height,this.depth),t=new THREE.Mesh(e,this.material);this.setObject3D(t)},WIDGET3D.TitledWindow=function(e){WIDGET3D.Group.call(this);var t=this,e=e||{};this.width=e.width!==undefined?e.width:2e3,this.height=e.height!==undefined?e.height:2e3;var n=e.title!==undefined?e.title:"title",r=e.override!==undefined?e.override:!1,i=e.color!==undefined?e.color:8421504,s=e.texture,o=e.material!==undefined?e.material:new THREE.MeshBasicMaterial({color:i,map:s,side:THREE.DoubleSide});this.title=new WIDGET3D.Widget;var u=this.createTitle(n,o.side);this.title.setObject3D(u),this.add(this.title);var a=new THREE.Mesh(new THREE.PlaneGeometry(this.width,this.height),o);this.content=new WIDGET3D.Widget(a),this.add(this.content);var f=new THREE.Mesh(new THREE.PlaneGeometry(this.width/10,this.height/10),new THREE.MeshBasicMaterial({color:11141120,side:o.side}));this.closeButton=new WIDGET3D.Widget(f),this.closeButton.setPosition(this.width/2-this.width/20,this.height/2+this.height/20,0),this.add(this.closeButton);if(!r){var l=function(e){return function(){e.remove(),console.log("removed!")}};this.closeButton.addEventListener("click",l(this))}this.defaultControls=e.defaultControls!==undefined?e.defaultControls:!1;if(this.defaultControls)var c=e.mouseButton!==undefined?e.mouseButton:0,h=e.shiftKey!==undefined?e.shiftKey:!1,p=e.attached!==undefined?e.attached:!1,d=e.debug!==undefined?e.debug:!1,v=new WIDGET3D.DragControl(this,{debug:d,mouseButton:c,shiftKey:h,width:this.width*2,height:(this.height+this.title.height)*2})},WIDGET3D.TitledWindow.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.TitledWindow.prototype.createTitle=function(e,t){this.textureCanvas=document.createElement("canvas"),this.textureCanvas.width=512,this.textureCanvas.height=128,this.textureCanvas.style.display="none",document.body.appendChild(this.textureCanvas),this.setTitle(e);var n=new THREE.Texture(this.textureCanvas);n.needsUpdate=!0;var r=new THREE.MeshBasicMaterial({map:n,side:t});this.title.width=this.width-this.width/10,this.title.height=this.height/10;var i=new THREE.Mesh(new THREE.PlaneGeometry(this.title.width,this.title.height),r);return i.position.y=this.height/2+this.height/20,i.position.x=(this.width-this.width/10)/2-this.width/2,i},WIDGET3D.TitledWindow.prototype.setTitle=function(e){var t=this.textureCanvas.getContext("2d");t.fillStyle="#B3B3B3",t.fillRect(0,0,this.textureCanvas.width,this.textureCanvas.height),t.fillStyle="#000000",t.font="bold 60px Courier New",t.align="center",t.textBaseline="middle",t.fillText(e,10,this.textureCanvas.height/2)},WIDGET3D.TitledWindow.prototype.updateTitle=function(e){return this.setTitle(e),this.title.object3D.material.map.needsUpdate=!0,this},WIDGET3D.TitledWindow.prototype.remove=function(){this.hide();var e=this.textureCanvas;document.body.removeChild(e),WIDGET3D.Group.prototype.remove.call(this)},WIDGET3D.TitledWindow.prototype.getContent=function(){return this.content},WIDGET3D.Dialog=function(e){WIDGET3D.Group.call(this);var e=e||{};this.width=e.width!==undefined?e.width:1e3,this.height=e.height!==undefined?e.height:1e3,this.depth=e.depth!==undefined?e.depth:20,this.color=e.color!==undefined?e.color:12636368,this.opacity=e.opacity!==undefined?e.opacity:.9,this.title=e.title!==undefined?e.title:"This is a dialog",this.fields=e.fields!==undefined?e.fields:[],this.buttons=e.buttons!==undefined?e.buttons:[],this.hasCancel=e.hasCancel!==undefined?e.hasCancel:!1;if(this.hasCancel){this.cancelText=e.cancelText!==undefined?e.cancelText:"Cancel";var t=function(e){return function(){e.remove()}};this.buttons.push({text:this.cancelText,onclick:t(this)})}this.componentHeight=this.height/((this.fields.length+3)*1.3),this.createDialogTitle(),this.createButtons(),this.createTextfields()},WIDGET3D.Dialog.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.Dialog.prototype.createDialogTitle=function(){this.canvas=document.createElement("canvas"),this.canvas.width=512,this.canvas.height=512,this.canvas.style.display="none",document.body.appendChild(this.canvas);var e=this.canvas.getContext("2d");e.fillStyle="#FFFFFF",e.fillRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle="#000000",e.font="bold 30px Courier New",e.align="center",e.textBaseline="middle";var t=e.measureText(this.title).width,n=e.measureText(this.title).height;e.fillText(this.title,this.canvas.width/2-t/2,30);var r=new THREE.Texture(this.canvas);r.needsUpdate=!0;var i=new Array;i.push(new THREE.MeshBasicMaterial({color:this.color,opacity:this.opacity})),i.push(new THREE.MeshBasicMaterial({map:r,color:this.color,opacity:this.opacity}));var s=new THREE.CubeGeometry(this.width,this.height,this.depth*.75);for(var o=0;o<s.faces.length;o++){var u=s.faces[o];o===4||o==5?u.materialIndex=0:u.materialIndex=1}s.materials=i;var a=new THREE.MeshFaceMaterial(i),f=new THREE.Mesh(s,a),l=new WIDGET3D.Widget;l.setObject3D(f),this.add(l)},WIDGET3D.Dialog.prototype.createButtons=function(){var e=this.width/(this.buttons.length+2),t=this.componentHeight,n=-this.width/2,r=-this.height/2+1,i=this.width/this.buttons.length,s=i/2,o=r+t/2,u=0;for(var a=0;a<this.buttons.length;++a){var f=document.createElement("canvas");f.width=512,f.height=128,f.style.display="none",document.body.appendChild(f),this.buttons[a].canvas=f;var l=f.getContext("2d");l.fillStyle="#B3B3B3",l.fillRect(0,0,f.width,f.height),l.fillStyle="#000000",l.font="bold 60px Courier New",l.align="center",l.textBaseline="middle";var c=l.measureText(this.buttons[a].text).width;l.fillText(this.buttons[a].text,f.width/2-c/2,f.height/2);var h=new THREE.Texture(f);h.needsUpdate=!0;var p=new THREE.MeshBasicMaterial({map:h}),d=new THREE.CubeGeometry(e,t,this.depth),v=this.createFaceMaterialsMesh(p,d),m=new WIDGET3D.Widget;m.setObject3D(v),m.addEventListener("click",this.buttons[a].onclick),this.add(m);if(a==0)var g=n+s;else var g=u+i;m.setPosition(g,o,this.getPosition().z),u=g}},WIDGET3D.Dialog.prototype.createTextfields=function(){var e=function(e){return function(t){t.stopPropagation(),t.preventDefault(),WIDGET3D.unfocusFocused(),e.focus()}},t=function(e){return function(t){t.stopPropagation();if(t.charCode!=0){var n=String.fromCharCode(t.charCode);e.addLetter(n)}else t.type=="keydown"&&(t.keyCode==8||t.keyCode==46)&&e.erase(1)}},n=function(e,t,n){return function(){var r=e.getContext("2d");r.fillStyle="#FFFFFF",r.fillRect(0,0,e.width,e.height),r.fillStyle="#000000",r.font="bold 50px Courier New",r.align="center",r.textBaseline="middle",r.fillText(t.textHandle,5,e.height/2),n.needsUpdate=!0}},r=this.width/2.5,i=this.componentHeight,s=-this.width/2,o=this.width/2,u=this.height/2-i,a=(this.height-2*i)/this.fields.length,f=a/2,l=o-r/1.5,c=s+r/1.5,h=0;for(var p=0;p<this.fields.length;++p){var d=document.createElement("canvas");d.width=512,d.height=128,d.style.display="none",document.body.appendChild(d),this.fields[p].canvas1=d;var v=new THREE.Texture(d),m=new THREE.MeshBasicMaterial({map:v}),g=new THREE.CubeGeometry(r,i,this.depth),y=this.createFaceMaterialsMesh(m,g),b=new WIDGET3D.Text({maxLength:this.fields[p].maxLength});b.setText(""),b.setObject3D(y),b.addEventListener("click",e(b)),b.addEventListener("keypress",t(b)),b.addEventListener("keydown",t(b)),b.addUpdateCallback(n(d,b,v)),this.fields[p].input=b,this.add(b);var w=document.createElement("canvas");w.width=512,w.height=128,w.style.display="none",document.body.appendChild(w),this.fields[p].canvas2=w;var E=w.getContext("2d");E.fillStyle="#FFFFFF",E.fillRect(0,0,w.width,w.height),E.fillStyle="#000000",E.font="bold 60px Courier New",E.align="center",E.textBaseline="middle";var S=E.measureText(this.fields[p].description).width;E.fillText(this.fields[p].description,w.width/2-S/2,w.height/2);var x=new THREE.Texture(w);x.needsUpdate=!0;var T=new THREE.MeshBasicMaterial({map:x,color:this.color,opacity:this.opacity}),N=new THREE.CubeGeometry(r,i,this.depth),C=this.createFaceMaterialsMesh(T,N),k=new WIDGET3D.Widget;k.setObject3D(C),this.add(k);if(p==0)var L=u-f;else var L=h-a;b.setPosition(l,L,this.getPosition().z),k.setPosition(c,L,this.getPosition().z),h=L}},WIDGET3D.Dialog.prototype.createFaceMaterialsMesh=function(e,t){var n=new Array;n.push(new THREE.MeshBasicMaterial({color:this.color,opacity:this.opacity})),n.push(e);for(var r=0;r<t.faces.length;r++){var i=t.faces[r];r===4||r==5?i.materialIndex=0:i.materialIndex=1}t.materials=n;var s=new THREE.MeshFaceMaterial(n),o=new THREE.Mesh(t,s);return o},WIDGET3D.Dialog.prototype.remove=function(){for(var e=0;e<this.buttons.length;++e)document.body.removeChild(this.buttons[e].canvas);for(var t=0;t<this.fields.length;++t)document.body.removeChild(this.fields[t].canvas1),document.body.removeChild(this.fields[t].canvas2);document.body.removeChild(this.canvas),WIDGET3D.Group.prototype.remove.call(this)},WIDGET3D.SelectDialog=function(e){WIDGET3D.Group.call(this);var e=e||{};this.width=e.width!==undefined?e.width:1e3,this.height=e.height!==undefined?e.height:1e3,this.depth=e.depth!==undefined?e.depth:10,this.color=e.color!==undefined?e.color:12636368,this.opacity=e.opacity!==undefined?e.opacity:.9,this.choices=e.choices!==undefined?e.choices:[],this.hasCancel=e.hasCancel!==undefined?e.hasCancel:!1,this.text=e.text!==undefined?e.text:!1;if(this.hasCancel){this.cancelText=e.cancelText!==undefined?e.cancelText:"Cancel";var t=function(e){return function(){e.remove()}},n=t(this);this.choices.push({string:this.cancelText,onclick:{handler:n}})}this.text?this.createText():this.choiceHeight=this.height/(this.choices.length*1.2),this.choiceCanvases=[],this.createChoises()},WIDGET3D.SelectDialog.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.SelectDialog.prototype.createText=function(){this.textCanvas=document.createElement("canvas"),this.textCanvas.width=512,this.textCanvas.height=128,this.textCanvas.style.display="none",document.body.appendChild(this.textCanvas);var e=this.textCanvas.getContext("2d");this.choiceHeight=this.height/((this.choices.length+1)*1.2);var t=this.createTitle(this.text,e,this.textCanvas);t.position.y=this.height*.5-this.choiceHeight*.5;var n=new WIDGET3D.Widget;n.setObject3D(t),this.add(n),this.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault()})},WIDGET3D.SelectDialog.prototype.createChoises=function(){var e=0;for(var t=0;t<this.choices.length;++t){var n=new WIDGET3D.Widget,r=document.createElement("canvas");this.choiceCanvases.push(r),r.width=512,r.height=128,r.style.display="none",document.body.appendChild(r);var i=r.getContext("2d"),s=this.width/1.2,o=this.choiceHeight,u=this.createButtonMaterial(this.choices[t].string,i,r),a=new THREE.CubeGeometry(s,o,this.depth);for(var f=0;f<a.faces.length;f++){var l=a.faces[f];f===4||f==5?l.materialIndex=0:l.materialIndex=1}a.materials=u;var c=new THREE.MeshFaceMaterial(u),h=new THREE.Mesh(a,c);n.setObject3D(h);var p=this.getPosition(),d=0;t==0?this.text?d=this.height*.5-o*1.7:d=this.height*.5-o*.5:d=e-1.2*o,e=d,n.setPosition(p.x,d,p.z),n.addEventListener("click",this.choices[t].onclick.handler),n.menuID=t,this.add(n)}},WIDGET3D.SelectDialog.prototype.createButtonMaterial=function(e,t,n){t.fillStyle="#FFFFFF",t.fillRect(0,0,n.width,n.height),t.fillStyle="#000000",t.font="bold 40px Courier New",t.align="center",t.textBaseline="middle";var r=t.measureText(e).width;t.fillText(e,n.width/2-r/2,n.height/2);var i=new THREE.Texture(n);i.needsUpdate=!0;var s=new Array;return s.push(new THREE.MeshBasicMaterial({color:this.color,opacity:this.opacity})),s.push(new THREE.MeshBasicMaterial({map:i,color:this.color,opacity:this.opacity})),s},WIDGET3D.SelectDialog.prototype.createTitle=function(e,t,n){t.fillStyle="#FFFFFF",t.fillRect(0,0,n.width,n.height),t.fillStyle="#000000",t.font="bold 45px Courier New",t.align="center",t.textBaseline="middle";var r=t.measureText(e).width;t.fillText(e,n.width/2-r/2,n.height/2);var i=new THREE.Texture(n);i.needsUpdate=!0;var s=new Array;s.push(new THREE.MeshBasicMaterial({color:this.color,opacity:this.opacity})),s.push(new THREE.MeshBasicMaterial({map:i,color:this.color,opacity:this.opacity}));var o=new THREE.CubeGeometry(this.width,this.choiceHeight,this.depth);for(var u=0;u<o.faces.length;u++){var a=o.faces[u];u===4||u===5?a.materialIndex=0:a.materialIndex=1}o.materials=s;var f=new THREE.MeshFaceMaterial(s),l=new THREE.Mesh(o,f);return l},WIDGET3D.SelectDialog.prototype.changeChoiceText=function(e,t){var n=!1;for(var r=0;r<this.children.length;++r)if(this.children[r].menuID==t){n=this.children[r];break}if(n){var i=n.object3D.material.map.image,s=n.object3D.material.map.image.getContext("2d"),o=this.createButtonMaterial(e,s,i);return n.object3D.geometry.materials=o,n.object3D.material=new THREE.MeshFaceMaterial(o),n.object3D.needsUpdate=!0,!0}return!1},WIDGET3D.SelectDialog.prototype.remove=function(){for(var e=0;e<this.choiceCanvases.length;++e)t=this.choiceCanvases[e],document.body.removeChild(t);this.choiceCanvases=null;var t=this.textCanvas;document.body.removeChild(t),WIDGET3D.Group.prototype.remove.call(this)},WIDGET3D.DragControl=function(e,t){WIDGET3D.Control.call(this,e);var t=t||{};this.mouseButton=t.mouseButton!==undefined?t.mouseButton:0,this.shiftKey=t.shiftKey!==undefined?t.shiftKey:!1;var n=this,r=t.width!==undefined?t.width:2e3,i=t.height!==undefined?t.height:2e3,s=t.debug!==undefined?t.debug:!1;this.plane=new THREE.Mesh(new THREE.PlaneGeometry(r,i,8,8),new THREE.MeshBasicMaterial({color:0,opacity:.25,transparent:!0,wireframe:!0,side:THREE.DoubleSide})),this.plane.visible=s,this.drag=!1;var o=WIDGET3D.getCamera(),u=new THREE.Vector3;this.mouseupHandler=function(e){n.drag&&(e.stopPropagation(),e.preventDefault(),n.drag=!1,n.plane.position.copy(n.component.parent.object3D.localToWorld(n.component.getPosition().clone())),WIDGET3D.getApplication().removeEventListener("mousemove",a),WIDGET3D.getApplication().removeEventListener("mouseup",n.mouseupHandler))},this.mousedownHandler=function(e){if(e.button===n.mouseButton&&e.shiftKey===n.shiftKey&&!n.drag){e.stopPropagation(),e.preventDefault(),f(),n.plane.position.copy(n.component.parent.object3D.localToWorld(n.component.getPosition().clone())),n.plane.updateMatrixWorld(!0);var t=WIDGET3D.mouseCoordinates(e),r=new THREE.Vector3(t.x,t.y,1),i=WIDGET3D.getProjector().pickingRay(r,o),s=i.intersectObject(n.plane);s.length>0&&u.copy(s[0].point).sub(n.plane.position),WIDGET3D.getApplication().addEventListener("mousemove",a),WIDGET3D.getApplication().addEventListener("mouseup",n.mouseupHandler),n.drag=!0}};var a=function(e){if(n.drag){e.stopPropagation(),e.preventDefault();var t=WIDGET3D.mouseCoordinates(e),r=new THREE.Vector3(t.x,t.y,1),i=WIDGET3D.getProjector().pickingRay(r,o),s=i.intersectObject(n.plane);if(s.length>0){var a=s[0].point.sub(u);n.plane.position.copy(a);var f=n.component.parent.object3D.worldToLocal(a);n.component.setPosition(f.x,f.y,f.z)}}},f=function(){var e=o.matrixWorld.clone(),t=new THREE.Matrix4;t.extractRotation(e),n.plane.setRotationFromMatrix(t),n.plane.updateMatrix()};f(),WIDGET3D.getScene().add(this.plane),this.mouseButton==2&&WIDGET3D.getApplication().addEventListener("contextmenu",function(e){e.stopPropagation(),e.preventDefault()}),this.component.addEventListener("mousedown",this.mousedownHandler)},WIDGET3D.DragControl.prototype=WIDGET3D.Control.prototype.inheritance(),WIDGET3D.DragControl.prototype.remove=function(){this.component.removeEventListener("mousedown",this.mousedownHandler),this.drag&&this.mouseupHandler(),WIDGET3D.getScene().remove(this.plane),this.plane.geometry.dispose(),this.plane.material.dispose(),this.plane=undefined,WIDGET3D.Control.prototype.remove.call(this)},WIDGET3D.FlyControl=function(e,t){WIDGET3D.Control.call(this,e);var t=t||{};this.left=t.leftKeyCode!==undefined?t.leftKeyCode:65,this.right=t.rightKeyCode!==undefined?t.rigthKeyCode:68,this.forward=t.forwardKeyCode!==undefined?t.forwardKeyCode:87,this.backward=t.backwardKeyCode!==undefined?t.backwardKeyCode:83,this.up=t.upKeyCode!==undefined?t.upKeyCode:82,this.down=t.downKeyCode!==undefined?t.downKeyCode:70,this.lookLeft=t.lookLeftKeyCode!==undefined?t.lookLeftKeyCode:74,this.lookRight=t.lookRightKeyCode!==undefined?t.lookRightKeyCode:76,this.lookUp=t.lookUpKeyCode!==undefined?t.lookUpKeyCode:73,this.lookDown=t.lookDownKeyCode!==undefined?t.lookDownKeyCode:75,this.ds=t.moveDelta!==undefined?t.moveDelta:50,this.da=t.angleDelta!==undefined?t.angleDelta:Math.PI/50;var n=this,r=Math.PI-Math.PI/100,i=-r;this.onkeydownHandler=function(e){switch(e.keyCode){case n.left:n.component.translateX(-n.ds);break;case n.right:n.component.translateX(n.ds);break;case n.forward:n.component.translateZ(-n.ds);break;case n.backward:n.component.translateZ(n.ds);break;case n.up:n.component.translateY(n.ds);break;case n.down:n.component.translateY(-n.ds);break;case n.lookLeft:n.component.rotateOnAxis(new THREE.Vector3(0,1,0),n.da);break;case n.lookRight:n.component.rotateOnAxis(new THREE.Vector3(0,1,0),-n.da);break;case n.lookUp:n.component.rotateOnAxis(new THREE.Vector3(1,0,0),n.da);break;case n.lookDown:n.component.rotateOnAxis(new THREE.Vector3(1,0,0),-n.da);break;default:return}},this.onkeyupHandler=function(e){},WIDGET3D.getApplication().addEventListener("keydown",this.onkeydownHandler)},WIDGET3D.FlyControl.prototype=WIDGET3D.Control.prototype.inheritance(),WIDGET3D.FlyControl.prototype.remove=function(){WIDGET3D.getApplication().removeEventListener("keydown",this.onkeydownHandler),WIDGET3D.Control.prototype.remove.call(this)}